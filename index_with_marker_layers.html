<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Citeen ‚Äì Carte COPRO IDF</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #map {
      position: absolute;
      top: 0; bottom: 0; right: 0; left: 0;
    }

    /* ==========================
       √âCRAN D‚ÄôOUVERTURE
    =========================== */
    .opening-screen {
      position: fixed;
      z-index: 20000;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: linear-gradient(
        135deg,
        #ffffff 0%,
        #f5faf7 35%,
        #d9f5e5 65%,
        #16a34a 100%
      );
      color: #0f172a;
    }

    .opening-inner {
      max-width: 640px;
      width: 100%;
      background: #ffffffee;
      border-radius: 18px;
      padding: 24px 24px 20px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.18);
      border: 1px solid rgba(22,163,74,0.25);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .opening-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .opening-logo-wrap {
      flex-shrink: 0;
      width: 48px;
      height: 48px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #bbf7d0 0, #16a34a 45%, #0d9488 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .opening-logo {
      max-width: 70%;
      max-height: 70%;
      display: block;
    }

    .opening-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .opening-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #065f46;
    }

    .opening-subtitle {
      font-size: 12px;
      color: #4b5563;
    }

    .opening-body {
      font-size: 14px;
      color: #374151;
      line-height: 1.5;
    }

    .opening-body strong {
      color: #047857;
      font-weight: 600;
    }

    .opening-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      font-size: 11px;
      color: #4b5563;
    }

    .opening-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .badge-env {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(22,163,74,0.4);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #065f46;
      background: #ecfdf5;
    }

    .opening-button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #064e3b;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 8px 25px rgba(34,197,94,0.4);
      transition: transform 0.08s ease-out, box-shadow 0.12s ease-out, background 0.12s;
    }

    .opening-button:hover {
      background: #16a34a;
      box-shadow: 0 10px 30px rgba(34,197,94,0.55);
      transform: translateY(-1px);
    }

    .opening-button:active {
      transform: translateY(1px);
      box-shadow: 0 4px 12px rgba(34,197,94,0.4);
    }

    .opening-hint {
      font-size: 11px;
      color: #6b7280;
    }

    .opening-screen.hidden {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-out;
    }

/* ==========================
       BARRE DE RECHERCHE
=========================== */
.search-panel {
  position: absolute;
  z-index: 10000;
  background: #1f2937ee; /* sombre + opaque soft */
  backdrop-filter: blur(10px);
  padding: 16px 20px;
  border-radius: 18px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.45);
  border: 1px solid rgba(255,255,255,0.12);
  display: flex;
  flex-direction: column;
  gap: 12px;
  color: #ffffff;
}

.search-panel.expanded {
  top: 20px;
  left: 20px;
  width: 520px;
}

.search-panel.mini {
  top: 20px;
  left: 20px;
  width: 260px;
  padding: 12px 14px;
  background: #1f2937f0;
  border-radius: 16px;
  backdrop-filter: blur(10px);
}

.search-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 4px;
  padding-bottom: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.15);
}

.search-logo-wrap {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.search-logo {
  height: 28px;
  display: block;
}

.search-header-text {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.search-brand {
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 0.02em;
  color: #ffffff;
}

.search-subtitle {
  font-size: 11px;
  color: #93c5fd; /* bleu clair joli */
}

.search-panel.mini .search-subtitle {
  display: none;
}

.search-panel.mini .search-logo {
  height: 22px;
}

.search-row {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.search-input, .search-select {
  flex: 1;
  padding: 7px 10px;
  border-radius: 8px;
  border: 1px solid #4b5563;
  font-size: 13px;
  outline: none;
  background-color: #374151; /* gris fonc√© */
  color: #f3f4f6; /* texte clair */
  transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
}

.search-input::placeholder {
  color: #9ca3af;
}

.search-input:focus, .search-select:focus {
  border-color: #60a5fa;
  box-shadow: 0 0 0 1px rgba(96,165,250,0.4);
}

.search-status {
  font-size: 11px;
  color: #cbd5e1;
  margin-top: 2px;
  line-height: 1.3;
  white-space: pre-line;
}

.search-icon-wrapper {
  position: relative;
  flex: 1;
}

.search-icon {
  position: absolute;
  right: 10px;
  top: 7px;
  font-size: 14px;
  color: #9ca3af;
  pointer-events: none;
}

.filter-label {
  font-size: 11px;
  color: #cbd5e1;
  margin-bottom: 2px;
}

.search-button {
  padding: 7px 12px;
  border-radius: 999px;
  border: 1px solid #4f46e5;
  background: #4f46e5;
  color: white;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.15s, transform 0.05s, box-shadow 0.15s;
  box-shadow: 0 1px 4px rgba(79,70,229,0.4);
  white-space: nowrap;
}

.search-button:hover {
  background: #4338ca;
  border-color: #4338ca;
  box-shadow: 0 2px 6px rgba(79,70,229,0.55);
}

.search-button:active {
  transform: translateY(1px);
  box-shadow: 0 1px 3px rgba(79,70,229,0.4);
}

.search-button-secondary {
  background: #374151;
  color: #e5e7eb;
  border-color: #4b5563;
  box-shadow: none;
}

.search-button-secondary:hover {
  background: #4b5563;
  border-color: #6b7280;
}

.search-panel.mini #advancedFilters {
  display: none;
}

.leaflet-control-layers {
  font-size: 12px;
}


    /* ==========================
       TOGGLE FOND OSM / SAT
    =========================== */
    .leaflet-control-basemap-toggle a {
      width: 34px;
      height: 26px;
      line-height: 26px;
      text-align: center;
      text-decoration: none;
      display: block;
      background: #fff;
      color: #111827;
      font-size: 11px;
      border-bottom: 1px solid #ccc;
    }

    .leaflet-control-basemap-toggle a:last-child {
      border-bottom: none;
    }

    .leaflet-control-basemap-toggle a.active {
      background: #16a34a;
      color: #fff;
      font-weight: 600;
    }

    /* ==========================
       PANNEAU INFOS DROITE
    =========================== */
   .info-sidebar {
  position: absolute;
  top: 20px;
  right: 20px;
  height: calc(100% - 40px);
  width: 360px;
  max-width: 90vw;
  background: #1f2937; /* gris tr√®s fonc√© */
  border-radius: 18px;
  box-shadow: 0 10px 35px rgba(0,0,0,0.45);
  z-index: 9000;
  display: flex;
  flex-direction: column;
  transform: translateX(200%);
  opacity: 0;
  transition: transform 0.25s ease-out, opacity 0.25s ease-out;
  color: #ffffff; /* texte blanc */
  border: 1px solid rgba(255,255,255,0.12);
}

    .info-sidebar.visible {
  transform: translateX(0);
  opacity: 1;
}

    .info-sidebar-header {
  padding: 16px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.15);
  background: #111827; /* plus fonc√© pour la barre du haut */
  border-radius: 18px 18px 0 0;
}

    .info-sidebar-title-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .info-sidebar-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: #16a34a;
      font-weight: 600;
    }

    .info-sidebar-title {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .info-sidebar-close-btn {
      border: none;
      background: #ffffff;
      width: 26px;
      height: 26px;
      padding: 0;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      color: #6b7280;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: background 0.15s, color 0.15s, transform 0.06s;
    }

    .info-sidebar-close-btn:hover {
      background: #f3f4f6;
      color: #111827;
    }

    .info-sidebar-close-btn:active {
      transform: translateY(1px);
    }

 .info-sidebar-content {
  padding: 18px 22px 22px;
  overflow-y: auto;
  font-size: 14px;
  line-height: 1.55;
  color: #e5e7eb; /* gris clair */
}

    .info-section {
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px dashed #e5e7eb;
    }

    .info-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .info-section-title {
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .06em;
  color: #60a5fa; /* bleu clair */
  margin-bottom: 6px;
}

    .info-field {
      margin: 2px 0;
    }

    .info-field-label {
  color: #93c5fd;
  font-weight: 600;
}

.info-field-value {
  color: #ffffff;
}

    .info-pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 11px;
      margin-right: 4px;
      margin-bottom: 2px;
      background: #eef2ff;
      color: #3730a3;
    }
  </style>

  <!-- Librairies -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Google Maps JS API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB4izaTwbsKKyjVuOJ2Bu0ZHfZRg7mv-ZA&libraries=places"></script>
  <!-- Plugin Leaflet pour utiliser Google comme fond -->
  <script src="https://unpkg.com/leaflet.gridlayer.googlemutant@0.11.2/dist/Leaflet.GoogleMutant.js"></script>
</head>
<body>

<!-- √âCRAN D‚ÄôOUVERTURE -->
<div id="openingScreen" class="opening-screen">
  <div class="opening-inner">
    <div class="opening-header">
      <div class="opening-logo-wrap">
        <img src="assets/LOGO CITEEN_RVB-min.png" alt="Citeen" class="opening-logo">
      </div>
      <div class="opening-title-block">
        <div class="opening-title">Citeen Cartographie</div>
        <div class="opening-subtitle">
          Registres de copropri√©t√©s ‚Äì √éle-de-France
        </div>
      </div>
    </div>

    <div class="opening-body">
      Explorez le patrimoine r√©sidentiel en copropri√©t√© en √éle-de-France.
      <br><br>
      Chaque point correspond √† une <strong>copropri√©t√© immatricul√©e</strong>.
      Un clic ouvre la <strong>fiche immeuble</strong> dans le panneau lat√©ral droit
      (adresse, syndic, lots, p√©riode de construction‚Ä¶).
    </div>

    <div class="opening-footer">
      <div class="opening-hint">
        √âtape 1 : acc√©der √† la carte<br>
        √âtape 2 : lancer une recherche (ou afficher tout).
      </div>
      <div class="opening-actions">
        <span class="badge-env">Pr√©-s√©rie</span>
        <button id="enterAppBtn" class="opening-button">
          Acc√©der √† la carte
          <span>‚ü∂</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- CARTE -->
<div id="map"></div>

<!-- PANNEAU DE RECHERCHE -->
<div class="search-panel expanded" id="searchPanel">

  <!-- HEADER CITEEN -->
  <div class="search-header">
    <div class="search-logo-wrap">
      <img
        src="assets/LOGO CITEEN_RVB-min.png"
        alt="Citeen"
        class="search-logo"
      />
    </div>
    <div class="search-header-text">
      <div class="search-brand">Citeen</div>
      <div class="search-subtitle">Recherche d'immeubles ¬∑ Registre des copropri√©t√©s</div>
    </div>
  </div>

  <!-- CHAMP PRINCIPAL -->
  <div class="search-row">
    <div class="search-icon-wrapper">
      <input
        type="text"
        id="searchInput"
        class="search-input"
        placeholder="Nom de copro, adresse, voie, commune‚Ä¶"
      />
      <span class="search-icon">üîç</span>
    </div>
  </div>

  <div id="advancedFilters">
    <!-- SYNDIC -->
    <div class="search-row">
      <div style="flex:1; display:flex; flex-direction:column;">
        <span class="filter-label">Nom du syndic</span>
        <input
          type="text"
          id="syndicInput"
          class="search-input"
          placeholder="Ex : NEXITY, FONCIA‚Ä¶"
        />
      </div>
    </div>

    <!-- CODE POSTAL -->
    <div class="search-row">
      <div style="flex:0.7; display:flex; flex-direction:column;">
        <span class="filter-label">Code postal</span>
        <input
          type="text"
          id="cpInput"
          class="search-input"
          placeholder="Ex : 75014"
        />
      </div>

      <div style="flex:1; display:flex; flex-direction:column;">
        <span class="filter-label">Ann√©e construction (approx. min / max)</span>
        <div class="search-row">
          <input
            type="number"
            id="anneeMinFilter"
            class="search-input"
            placeholder="min (ex : 1950)"
          />
          <input
            type="number"
            id="anneeMaxFilter"
            class="search-input"
            placeholder="max (ex : 2000)"
          />
        </div>
      </div>
    </div>
  </div>

  <!-- BOUTONS -->
  <div class="search-row" style="justify-content:flex-end; margin-top:4px; gap:8px;">
    <button id="resetBtn" class="search-button search-button-secondary">R√©initialiser</button>
    <button id="exportBtn" class="search-button search-button-secondary">Exporter (CSV)</button>
    <button id="searchBtn" class="search-button">Lancer la recherche</button>
  </div>

  <div id="status" class="search-status">Chargement des CSV‚Ä¶</div>
</div>

<!-- PANNEAU INFOS √Ä DROITE -->
<div id="infoSidebar" class="info-sidebar">
  <div class="info-sidebar-header">
    <div class="info-sidebar-title-wrap">
      <div class="info-sidebar-label">Fiche immeuble</div>
      <div id="infoSidebarTitle" class="info-sidebar-title">S√©lection en cours‚Ä¶</div>
    </div>
    <button id="infoSidebarClose" class="info-sidebar-close-btn" title="Fermer">
      ‚úï
    </button>
  </div>
  <div id="infoSidebarContent" class="info-sidebar-content">
    <p style="font-size:13px; color:#6b7280;">
      Cliquez sur un point de la carte pour afficher ici les informations
      issues du registre des copropri√©t√©s (adresse, syndic, lots, p√©riode de construction‚Ä¶).
    </p>
  </div>
</div>

<script>
/* -----------------------------------------------------
   CONFIG ‚Äì FICHIERS COPRO PAR D√âPARTEMENT
------------------------------------------------------ */
const COPRO_FILES = [
  "csvcopro/registredescopro75.csv",
  "csvcopro/registredescopro77.csv",
  "csvcopro/registredescopro78.csv",
  "csvcopro/registredescopro91.csv",
  "csvcopro/registredescopro92.csv",
  "csvcopro/registredescopro93.csv",
  "csvcopro/registredescopro94.csv",
  "csvcopro/registredescopro95.csv"
];


const MAX_POINTS_DISPLAYED = 50000;

/* API DPE ADEME */
const DPE_API_URL = "https://data.ademe.fr/data-fair/api/v1/datasets/dpe-france/lines";


/* Donn√©es / index */
const pointIndex = new Map(); // cl√© "lat|lon" -> { lat, lon, copro: [rows] }
let allCoproRows = [];
let lastFilteredPoints = [];
let lastFilteredCoproRows = [];
/* Cache DPE pour √©viter les appels multiples */
const dpeCache = new Map(); // key "lat|lon" -> dpe object


/* Carte / couches */
let map;
let baseOSM, googleSat;
let markerLayer;
let btnOSMRef = null;
let btnSatRef = null;
let currentBase = "osm";
let dpeCollectifLayer = L.layerGroup();
let dpeIndividuelLayer = L.layerGroup();
let dpeNoneLayer = L.layerGroup();
// Calques par classe DPE
const dpeClassLayers = {
  "A": L.layerGroup(),
  "B": L.layerGroup(),
  "C": L.layerGroup(),
  "D": L.layerGroup(),
  "E": L.layerGroup(),
  "F": L.layerGroup(),
  "G": L.layerGroup()
};


/* UI */
let hasSearched = false;
let searchPanelMinimized = false;
let infoSidebarEl = null;
let infoSidebarContentEl = null;
let infoSidebarTitleEl = null;

/* -----------------------------------------------------
   UTILITAIRES
------------------------------------------------------ */
function parseNumberFlexible(value) {
  if (value === undefined || value === null || value === "") return NaN;
  const num = parseFloat(String(value).replace(",", "."));
  return isFinite(num) ? num : NaN;
}

/* -----------------------------------------------------
   GEO ‚Äì LAT/LON POUR COPRO
   (Registre : colonnes "long" et "lat")
------------------------------------------------------ */
function getLatLonFromCoproRow(row) {
  if (!row) return null;

  // 1) lecture brute
  let lat = row["lat"] ?? row["Lat"] ?? row["LAT"];
  let lon = row["long"] ?? row["Long"] ?? row["LONG"];

  // 2) S√©curisation : suppression espaces, guillemets, etc.
  if (typeof lat === "string") lat = lat.trim().replace(",", ".");
  if (typeof lon === "string") lon = lon.trim().replace(",", ".");

  // 3) Conversion
  lat = Number(lat);
  lon = Number(lon);

  // 4) Validation : coordonn√©es r√©alistes IDF
  if (!isFinite(lat) || !isFinite(lon)) return null;
  if (lat < 48 || lat > 49.5) return null;
  if (lon < 1 || lon > 3.8) return null;

  return [lat, lon];
}


/* -----------------------------------------------------
   INDEX ‚Äì UN POINT = UNE COPRO (ici)
------------------------------------------------------ */
function addCoproRowToIndex(row) {
  const coords = getLatLonFromCoproRow(row);
  if (!coords) return;
  const [lat, lon] = coords;

  const key = lat.toFixed(5) + "|" + lon.toFixed(5);

  if (!pointIndex.has(key)) {
    pointIndex.set(key, {
      key,
      lat,
      lon,
      copro: []
    });
  }

  const p = pointIndex.get(key);
  p.copro.push(row);
}

/* -----------------------------------------------------
   SIDEBAR ‚Äì OUVRIR / FERMER
------------------------------------------------------ */
function openSidebar(title, htmlContent) {
  if (!infoSidebarEl || !infoSidebarContentEl || !infoSidebarTitleEl) return;
  infoSidebarTitleEl.textContent = title || "Immeuble";
  infoSidebarContentEl.innerHTML = htmlContent;
  infoSidebarEl.classList.add("visible");
}

function closeSidebar() {
  if (!infoSidebarEl) return;
  infoSidebarEl.classList.remove("visible");
}

/* -----------------------------------------------------
   CONTENU DE LA FICHE IMMEUBLE
------------------------------------------------------ */
function buildSidebarHtmlForPoint(p) {
  const c = p.copro[0] || {};

  const nomCopro =
    c["nom_d_usage_de_la_copropriete"] ||
    c["nom_d_usage_de_la_copropriete_COPRO"] ||
    c["nom_d_usage_copropriete"] ||
    "Copropri√©t√©";

  const adresse =
    c["adresse_de_reference"] ||
    ((c["numero_et_voie_adresse_de_reference"] || "") + " " +
     (c["adresse_complementaire_1"] || "")).trim();

  const cp =
    c["code_postal_adresse_de_reference"] ||
    c["code_postal"] ||
    "";

  const commune =
    c["commune_adresse_de_reference"] ||
    c["nom_officiel_commune"] ||
    c["commune"] ||
    "";

  const syndic =
    c["raison_sociale_du_representant_legal"] ||
    "Non renseign√©";

  const typeSyndic =
    c["type_de_syndic_benevole_professionnel_non_connu"] ||
    "Non renseign√©";

  const numImmat =
    c["numero_d_immatriculation"] ||
    "Non renseign√©";

  const periodeConstr =
    c["periode_de_construction"] ||
    "Non renseign√©e";

  const nbLotsTotal =
    c["nombre_total_de_lots"] ||
    "Non renseign√©";

  const nbLotsHab =
    c["nombre_total_de_lots_a_usage_d_habitation_de_bureaux_ou_de_comm"] ||
    c["nombre_de_lots_a_usage_d_habitation"] ||
    "";

  const nbLotsStationnement =
    c["nombre_de_lots_de_stationnement"] ||
    "";

  let html = `
    <div class="info-section">
      <div class="info-section-title">Localisation</div>
      <div class="info-field">
        <span class="info-field-label">Nom de la copropri√©t√© :</span>
        <span class="info-field-value">${nomCopro}</span>
      </div>
      <div class="info-field">
        <span class="info-field-label">Adresse :</span>
        <span class="info-field-value">
          ${adresse || "Non renseign√©e"}<br>
          ${cp || ""} ${commune || ""}
        </span>
      </div>
      <div class="info-field">
        <span class="info-field-label">Coordonn√©es :</span>
        <span class="info-field-value">
          ${p.lat.toFixed(6)}, ${p.lon.toFixed(6)}
        </span>
      </div>
    </div>

    <div class="info-section">
      <div class="info-section-title">Copropri√©t√©</div>
      <div class="info-field">
        <span class="info-field-label">N¬∞ d'immatriculation :</span>
        <span class="info-field-value">${numImmat}</span>
      </div>
      <div class="info-field">
        <span class="info-field-label">Syndic :</span>
        <span class="info-field-value">${syndic}</span>
      </div>
      <div class="info-field">
        <span class="info-field-label">Type de syndic :</span>
        <span class="info-field-value">${typeSyndic}</span>
      </div>
      <div class="info-field">
        <span class="info-field-label">P√©riode de construction :</span>
        <span class="info-field-value">${periodeConstr}</span>
      </div>
      <div class="info-field">
        <span class="info-field-label">Nombre total de lots :</span>
        <span class="info-field-value">${nbLotsTotal}</span>
      </div>
  `;

  if (nbLotsHab || nbLotsStationnement) {
    html += `
      <div class="info-field">
        <span class="info-field-label">D√©tail lots :</span>
        <span class="info-field-value">
          ${nbLotsHab ? nbLotsHab + " lots habitation/bureaux/commerces<br>" : ""}
          ${nbLotsStationnement ? nbLotsStationnement + " lots de stationnement" : ""}
        </span>
      </div>
    `;
  }

  html += `
    </div>
  `;

  if (p.copro.length > 1) {
    html += `
      <div class="info-section">
        <div class="info-section-title">Donn√©es sources</div>
        <div class="info-field">
          <span class="info-field-label">Lignes registre sur ce point :</span>
          <span class="info-field-value">${p.copro.length}</span>
        </div>
      </div>
    `;
  }

  return { title: nomCopro, html };
}

/* -----------------------------------------------------
   CARTE LEAFLET + FONDS
------------------------------------------------------ */

async function fetchDPEForCoordinates(lat, lon) {
  const key = lat.toFixed(6) + "|" + lon.toFixed(6);

  if (dpeCache.has(key)) {
    return dpeCache.get(key);
  }

  const url = `${DPE_API_URL}?size=1&geo_distance=${lon},${lat},25`;

  try {
    const res = await fetch(url);
    if (!res.ok) {
      dpeCache.set(key, null);
      return null;
    }

    const data = await res.json();
    const dpe = data?.results?.[0] || null;

    dpeCache.set(key, dpe);
    return dpe;

  } catch (e) {
    console.error("Erreur DPE API :", e);
    dpeCache.set(key, null);
    return null;
  }
}


function appendDPEToSidebar(dpe) {
  if (!infoSidebarContentEl) return;

  let html = `
    <div class="info-section">
      <div class="info-section-title">Diagnostic √©nerg√©tique üîã</div>
  `;

  if (!dpe) {
    html += `<div class="info-field">Aucun DPE trouv√©.</div></div>`;
    infoSidebarContentEl.innerHTML += html;
    return;
  }

  // D√©termination du type (individuel / collectif)
  let typeDPE = "Individuel";
  if (dpe.tr002_type_batiment_description) {
    const t = dpe.tr002_type_batiment_description.toLowerCase();
    if (t.includes("immeuble") || t.includes("collectif")) {
      typeDPE = "Collectif";
    }
  }

  // √ânergie de chauffage principal
  const energieChauffage =
    dpe.energie_chauffage ||
    dpe.energie_chauffage_1 ||
    dpe.energie_emetteur ||
    "Non renseign√©e";

  html += `
    <div class="info-field">
      <span class="info-field-label">Num√©ro DPE :</span>
      <span class="info-field-value">${dpe.numero_dpe || "Non renseign√©"}</span>
    </div>

    <div class="info-field">
      <span class="info-field-label">Date du DPE :</span>
      <span class="info-field-value">${dpe.date_etablissement_dpe || "Non renseign√©e"}</span>
    </div>

    <div class="info-field">
      <span class="info-field-label">Type de DPE :</span>
      <span class="info-field-value">${typeDPE}</span>
    </div>

    <div class="info-field">
      <span class="info-field-label">√ânergie chauffage principal :</span>
      <span class="info-field-value">${energieChauffage}</span>
    </div>

    <div class="info-field">
      <span class="info-field-label">Classe √©nergie :</span>
      <span class="info-field-value">${dpe.classe_consommation_energie || "NR"}</span>
    </div>

    <div class="info-field">
      <span class="info-field-label">Consommation √©nergie :</span>
      <span class="info-field-value">${dpe.consommation_energie || "NR"}</span>
    </div>

    <div class="info-field">
      <span class="info-field-label">Classe GES :</span>
      <span class="info-field-value">${dpe.classe_estimation_ges || "NR"}</span>
    </div>
  </div>`;
  
  infoSidebarContentEl.innerHTML += html;
}


function initMap() {
  baseOSM = L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }
  );

  googleSat = L.gridLayer.googleMutant({
    type: "satellite",
    maxZoom: 21
  });

  const boundsIDF = [
    [48.0, 1.4],
    [49.2, 3.6]
  ];

  map = L.map('map', {
    center: [48.8566, 2.3522],
    zoom: 11,
    layers: [baseOSM]
  });

  map.setMaxBounds(boundsIDF);
  map.setMinZoom(9);
  map.options.maxBoundsViscosity = 1.0;
  map.fitBounds(boundsIDF);

  markerLayer = L.layerGroup().addTo(map);

  const baseLayers = {
    "Fond OSM": baseOSM,
    "Satellite Google": googleSat
  };

 const dpeOverlays = {
  // Type de b√¢timent
  "DPE collectif": dpeCollectifLayer,
  "DPE individuel": dpeIndividuelLayer,
  "Sans donn√©es DPE": dpeNoneLayer,

  // Classes √©nerg√©tiques
  "Classe A": dpeClassLayers["A"],
  "Classe B": dpeClassLayers["B"],
  "Classe C": dpeClassLayers["C"],
  "Classe D": dpeClassLayers["D"],
  "Classe E": dpeClassLayers["E"],
  "Classe F": dpeClassLayers["F"],
  "Classe G": dpeClassLayers["G"]
};


L.control.layers(baseLayers, dpeOverlays, {
    position: "topright",
    collapsed: false
}).addTo(map);

// Ajoute les calques sur la carte
dpeCollectifLayer.addTo(map);
dpeIndividuelLayer.addTo(map);
dpeNoneLayer.addTo(map);
// Ajout des calques DPE A‚ÜíG activ√©s par d√©faut
Object.values(dpeClassLayers).forEach(layer => layer.addTo(map));



  const BaseMapToggle = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function(map) {
      const container = L.DomUtil.create('div', 'leaflet-control leaflet-bar leaflet-control-basemap-toggle');

      btnOSMRef = L.DomUtil.create('a', '', container);
      btnOSMRef.href = '#';
      btnOSMRef.innerHTML = 'OSM';
      btnOSMRef.classList.add('active');

      btnSatRef = L.DomUtil.create('a', '', container);
      btnSatRef.href = '#';
      btnSatRef.innerHTML = 'Sat';

      L.DomEvent.disableClickPropagation(container);

      L.DomEvent.on(btnOSMRef, 'click', function (e) {
        L.DomEvent.preventDefault(e);
        setBaseLayer('osm');
      });

      L.DomEvent.on(btnSatRef, 'click', function (e) {
        L.DomEvent.preventDefault(e);
        setBaseLayer('sat');
      });

      return container;
    }
  });

  map.addControl(new BaseMapToggle());

  map.on("click", () => {
    closeSidebar();
  });
}

function setBaseLayer(mode) {
  currentBase = mode;

  if (mode === "osm") {
    if (map.hasLayer(googleSat)) map.removeLayer(googleSat);
    if (!map.hasLayer(baseOSM)) map.addLayer(baseOSM);
    if (btnOSMRef && btnSatRef) {
      btnOSMRef.classList.add("active");
      btnSatRef.classList.remove("active");
    }
  } else if (mode === "sat") {
    if (map.hasLayer(baseOSM)) map.removeLayer(baseOSM);
    if (!map.hasLayer(googleSat)) map.addLayer(googleSat);
    if (btnOSMRef && btnSatRef) {
      btnOSMRef.classList.remove("active");
      btnSatRef.classList.add("active");
    }
  }
}

/* -----------------------------------------------------
   CHARGEMENT CSV ‚Äì MULTI FICHIERS
------------------------------------------------------ */
function loadCsv(fileName) {
  return new Promise((resolve, reject) => {
    Papa.parse(fileName, {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      delimiter: ";",
      complete: (result) => {
        resolve(result.data || []);
      },
      error: (err) => {
        reject(err);
      }
    });
  });
}

async function loadAllCoproData() {
  const statusEl = document.getElementById("status");
  statusEl.innerText = "Chargement des registres de copropri√©t√©s‚Ä¶";

  let totalRows = 0;
  let totalWithCoords = 0;

  for (const file of COPRO_FILES) {
    try {
      statusEl.innerText += `\n‚Üí ${file}‚Ä¶`;
      const rows = await loadCsv(file);
      allCoproRows.push(...rows);
      totalRows += rows.length;

      rows.forEach(r => {
        const coords = getLatLonFromCoproRow(r);
        if (coords) {
          totalWithCoords++;
          addCoproRowToIndex(r);
        }
      });

      console.log("Charg√© :", file, "lignes :", rows.length);
    } catch (e) {
      console.error("Erreur CSV COPRO sur", file, e);
      statusEl.innerText += `\n‚ö†Ô∏è Erreur sur ${file} (voir console).`;
    }
  }

  statusEl.innerText +=
    `\n\nTotal lignes COPRO : ${totalRows}` +
    `\nImmeubles g√©olocalis√©s (points) : ${pointIndex.size}` +
    `\nLancez une recherche pour afficher les points.`;

  console.log("PointIndex size :", pointIndex.size);
}

/* -----------------------------------------------------
   RENDU DES POINTS
------------------------------------------------------ */
function renderPoints(points) {
  // On vide tous les calques
  markerLayer.clearLayers();
  dpeCollectifLayer.clearLayers();
  dpeIndividuelLayer.clearLayers();
  dpeNoneLayer.clearLayers();
  Object.values(dpeClassLayers).forEach(layer => layer.clearLayers());


  const bounds = [];
  let displayed = 0;

  for (const p of points) {
    if (displayed >= MAX_POINTS_DISPLAYED) break;

    const lat = p.lat;
    const lon = p.lon;
    if (!isFinite(lat) || !isFinite(lon)) continue;

    // Cr√©ation du marker
    const marker = L.circleMarker([lat, lon], {
      radius: 5,
      color: "#0044ff",
      fillColor: "#3388ff",
      fillOpacity: 0.85,
      weight: 1
    }).on("click", async (e) => {
      L.DomEvent.stopPropagation(e);
      const { title, html } = buildSidebarHtmlForPoint(p);
      openSidebar(title, html);

      infoSidebarContentEl.innerHTML += `
        <div id="dpe-loading" class="info-section">
          <div class="info-section-title">DPE</div>
          <div class="info-field">Chargement‚Ä¶</div>
        </div>`;

      const dpeFull = await fetchDPEForCoordinates(p.lat, p.lon);
      const ld = document.getElementById("dpe-loading");
      if (ld) ld.remove();
      appendDPEToSidebar(dpeFull);
    });

    // Tous les markers dans le layer "g√©n√©ral"
    markerLayer.addLayer(marker);

    // Par d√©faut ‚Üí Sans DPE
    dpeNoneLayer.addLayer(marker);

    // Chargement du DPE en arri√®re-plan pour r√©partir dans les bons calques
    fetchDPEForCoordinates(lat, lon)
  .then((dpe) => {
    if (!dpe) return;

    const desc = (dpe.tr002_type_batiment_description || "").toLowerCase();

    // Retirer du calque "Sans DPE"
    dpeNoneLayer.removeLayer(marker);

    if (desc.includes("collectif") || desc.includes("immeuble")) {
      dpeCollectifLayer.addLayer(marker);
    } else {
      dpeIndividuelLayer.addLayer(marker);
    }

    // Ajout au calque de classe √©nerg√©tique (A‚ÜíG)
    const classe = (dpe.classe_consommation_energie || "").toUpperCase();
    if (["A","B","C","D","E","F","G"].includes(classe)) {
      dpeClassLayers[classe].addLayer(marker);
    }

  })
  .catch((err) => {
    console.error("Erreur DPE pour calques :", err);
  });

bounds.push([lat, lon]);
displayed++;

  }

  if (bounds.length > 0) {
    map.fitBounds(bounds, { padding: [20, 20] });
  }
}

/* -----------------------------------------------------
   FILTRES
------------------------------------------------------ */
function extractYearRangeFromPeriode(periodeStr) {
  if (!periodeStr) return null;
  const matches = String(periodeStr).match(/(19|20)\d{2}/g);
  if (!matches || matches.length === 0) return null;

  const years = matches.map(y => parseInt(y, 10)).filter(y => !isNaN(y));
  if (years.length === 0) return null;

  const minY = Math.min(...years);
  const maxY = Math.max(...years);
  return { min: minY, max: maxY };
}

function applyFilters() {
  const adresse      = document.getElementById("searchInput").value.toLowerCase().trim();
  const syndicFilter = document.getElementById("syndicInput").value.toLowerCase().trim();
  const cpFilter     = document.getElementById("cpInput").value.trim();
  const anneeMin     = parseInt(document.getElementById("anneeMinFilter").value, 10);
  const anneeMax     = parseInt(document.getElementById("anneeMaxFilter").value, 10);

  const filteredPoints = [];
  lastFilteredCoproRows = [];

  pointIndex.forEach(p => {
    let match = true;

    const c = p.copro[0] || {};

    // Adresse
    if (adresse) {
      const addrConcat =
        (c["nom_d_usage_de_la_copropriete"] || "") + " " +
        (c["adresse_de_reference"] || "") + " " +
        (c["numero_et_voie_adresse_de_reference"] || "") + " " +
        (c["commune_adresse_de_reference"] || "") + " " +
        (c["commune"] || "");
      if (!addrConcat.toLowerCase().includes(adresse)) {
        match = false;
      }
    }

    // Syndic
    if (match && syndicFilter) {
      const syndic =
        (c["raison_sociale_du_representant_legal"] || "").toLowerCase();
      if (!syndic.includes(syndicFilter)) {
        match = false;
      }
    }

    // Code postal
    if (match && cpFilter) {
      const cp =
        c["code_postal_adresse_de_reference"] ||
        c["code_postal"] ||
        "";
      if (!String(cp).startsWith(cpFilter)) {
        match = false;
      }
    }

    // P√©riode de construction approximative
    if (match && (!isNaN(anneeMin) || !isNaN(anneeMax))) {
      const periode =
        c["periode_de_construction"] ||
        "";
      const yr = extractYearRangeFromPeriode(periode);
      if (yr) {
        if (!isNaN(anneeMin) && yr.max < anneeMin) match = false;
        if (!isNaN(anneeMax) && yr.min > anneeMax) match = false;
      }
      // si pas d'info, on ne filtre pas plus (on laisse passer)
    }

    if (match) {
      filteredPoints.push(p);
      lastFilteredCoproRows.push(...p.copro);
    }
  });

  lastFilteredPoints = filteredPoints;
  renderPoints(filteredPoints);

  const statusEl = document.getElementById("status");
  statusEl.innerText =
    `Immeubles g√©olocalis√©s dans l'index : ${pointIndex.size}\n` +
    `Immeubles correspondant aux filtres : ${filteredPoints.length}\n` +
    `Lignes registre correspondantes : ${lastFilteredCoproRows.length}`;
}

/* -----------------------------------------------------
   EXPORT CSV
------------------------------------------------------ */
async function exportFilteredToCSV() {
  if (!lastFilteredCoproRows || lastFilteredCoproRows.length === 0) {
    alert("Aucune copropri√©t√© filtr√©e √† exporter. Lancez une recherche.");
    return;
  }

  // 1. Charger tous les DPE pour les points filtr√©s
  for (const p of lastFilteredPoints) {
    await fetchDPEForCoordinates(p.lat, p.lon);
  }

  // 2. Enrichir les lignes des registres avec les champs DPE
  const enrichedRows = lastFilteredCoproRows.map(row => {
    const coords = getLatLonFromCoproRow(row);
    if (!coords) return row;

    const [lat, lon] = coords;
    const key = lat.toFixed(6) + "|" + lon.toFixed(6);
    const dpe = dpeCache.get(key);

    return {
      ...row,
      dpe_numero: dpe?.numero_dpe || "",
      dpe_date: dpe?.date_etablissement_dpe || "",
      dpe_classe_energie: dpe?.classe_consommation_energie || "",
      dpe_conso: dpe?.consommation_energie || "",
      dpe_classe_ges: dpe?.classe_estimation_ges || "",
      dpe_energie_chauffage:
        dpe?.energie_chauffage ||
        dpe?.energie_chauffage_1 ||
        ""
    };
  });

  // 3. Conversion CSV
  const csv = Papa.unparse(enrichedRows, { delimiter: ";" });

  // 4. Download
  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.href = url;
  link.download = "export_citeen_copro_filtre_dpe.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}


/* -----------------------------------------------------
   R√âINITIALISATION
------------------------------------------------------ */
function resetFilters() {
  document.getElementById("searchInput").value = "";
  document.getElementById("syndicInput").value = "";
  document.getElementById("cpInput").value = "";
  document.getElementById("anneeMinFilter").value = "";
  document.getElementById("anneeMaxFilter").value = "";

  markerLayer.clearLayers();
  lastFilteredCoproRows = [];
  lastFilteredPoints = [];

  hasSearched = false;
  searchPanelMinimized = false;

  const panel = document.getElementById("searchPanel");
  panel.classList.remove("mini");
  panel.classList.add("expanded");

  const statusEl = document.getElementById("status");
  statusEl.innerText =
    "Recherche r√©initialis√©e.\nAucun point affich√©. Lancez une recherche.";

  closeSidebar();
}

/* -----------------------------------------------------
   MINIMISATION PANEL
------------------------------------------------------ */
function minimizeSearchPanel() {
  if (searchPanelMinimized) return;
  const panel = document.getElementById("searchPanel");
  panel.classList.remove("expanded");
  panel.classList.add("mini");
  searchPanelMinimized = true;
}

/* -----------------------------------------------------
   DOM READY
------------------------------------------------------ */
document.addEventListener("DOMContentLoaded", () => {
  initMap();

  infoSidebarEl = document.getElementById("infoSidebar");
  infoSidebarContentEl = document.getElementById("infoSidebarContent");
  infoSidebarTitleEl = document.getElementById("infoSidebarTitle");
  const infoSidebarClose = document.getElementById("infoSidebarClose");
  if (infoSidebarClose) {
    infoSidebarClose.addEventListener("click", closeSidebar);
  }

  // S'assurer que le bandeau est bien cach√© au d√©part
  closeSidebar();

  const openingScreen = document.getElementById("openingScreen");
  const enterAppBtn   = document.getElementById("enterAppBtn");

  if (enterAppBtn && openingScreen) {
    enterAppBtn.addEventListener("click", () => {
      openingScreen.classList.add("hidden");
    });
  }

  const searchBtn   = document.getElementById("searchBtn");
  const resetBtn    = document.getElementById("resetBtn");
  const exportBtn   = document.getElementById("exportBtn");
  const searchInput = document.getElementById("searchInput");

  if (searchBtn) {
    searchBtn.addEventListener("click", () => {
      hasSearched = true;
      applyFilters();
      minimizeSearchPanel();
    });
  }

  if (resetBtn) {
    resetBtn.addEventListener("click", resetFilters);
  }

  if (exportBtn) {
    exportBtn.addEventListener("click", exportFilteredToCSV);
  }

  if (searchInput) {
    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        hasSearched = true;
        applyFilters();
        minimizeSearchPanel();
      }
    });
    searchInput.addEventListener("input", () => {
      if (hasSearched) applyFilters();
    });
  }

  const syndicInput   = document.getElementById("syndicInput");
  const cpInput       = document.getElementById("cpInput");
  const anneeMinInput = document.getElementById("anneeMinFilter");
  const anneeMaxInput = document.getElementById("anneeMaxFilter");

  const liveApply = () => { if (hasSearched) applyFilters(); };

  if (syndicInput)   syndicInput.addEventListener("input", liveApply);
  if (cpInput)       cpInput.addEventListener("input", liveApply);
  if (anneeMinInput) anneeMinInput.addEventListener("input", liveApply);
  if (anneeMaxInput) anneeMaxInput.addEventListener("input", liveApply);

  // Chargement de tous les CSV COPRO
  loadAllCoproData();
});
</script>

</body>
</html>