<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Citeen ‚Äì Carte COPRO IDF</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    #map {
      position: absolute;
      top: 0; bottom: 0; right: 0; left: 0;
    }

    /* ==========================
       √âCRAN D‚ÄôOUVERTURE
    =========================== */
    

/* ==========================
       BARRE DE RECHERCHE
=========================== */
.search-panel {
  position: absolute;
  z-index: 10000;
  background: #1f2937ee; /* sombre + opaque soft */
  backdrop-filter: blur(10px);
  padding: 16px 20px;
  border-radius: 18px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.45);
  border: 1px solid rgba(255,255,255,0.12);
  display: flex;
  flex-direction: column;
  gap: 12px;
  color: #ffffff;
}

.search-panel.expanded {
  top: 20px;
  left: 20px;
  width: 520px;
}

.search-panel.mini {
  top: 20px;
  left: 20px;
  width: 260px;
  padding: 12px 14px;
  background: #1f2937f0;
  border-radius: 16px;
  backdrop-filter: blur(10px);
}

.search-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 4px;
  padding-bottom: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.15);
}

.search-logo-wrap {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.search-logo {
  height: 28px;
  display: block;
}

.search-header-text {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.search-brand {
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 0.02em;
  color: #ffffff;
}

.search-subtitle {
  font-size: 11px;
  color: #93c5fd; /* bleu clair joli */
}

.search-panel.mini .search-subtitle {
  display: none;
}

.search-panel.mini .search-logo {
  height: 22px;
}

.search-row {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.search-input, .search-select {
  flex: 1;
  padding: 7px 10px;
  border-radius: 8px;
  border: 1px solid #4b5563;
  font-size: 13px;
  outline: none;
  background-color: #374151; /* gris fonc√© */
  color: #f3f4f6; /* texte clair */
  transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
}

.search-input::placeholder {
  color: #9ca3af;
}

.search-input:focus, .search-select:focus {
  border-color: #60a5fa;
  box-shadow: 0 0 0 1px rgba(96,165,250,0.4);
}

.search-status {
  font-size: 11px;
  color: #cbd5e1;
  margin-top: 2px;
  line-height: 1.3;
  white-space: pre-line;
}

.search-icon-wrapper {
  position: relative;
  flex: 1;
}

.search-icon {
  position: absolute;
  right: 10px;
  top: 7px;
  font-size: 14px;
  color: #9ca3af;
  pointer-events: none;
}

.filter-label {
  font-size: 11px;
  color: #cbd5e1;
  margin-bottom: 2px;
}

.search-button {
  padding: 7px 12px;
  border-radius: 999px;
  border: 1px solid #4f46e5;
  background: #4f46e5;
  color: white;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.15s, transform 0.05s, box-shadow 0.15s;
  box-shadow: 0 1px 4px rgba(79,70,229,0.4);
  white-space: nowrap;
}

.search-button:hover {
  background: #4338ca;
  border-color: #4338ca;
  box-shadow: 0 2px 6px rgba(79,70,229,0.55);
}

.search-button:active {
  transform: translateY(1px);
  box-shadow: 0 1px 3px rgba(79,70,229,0.4);
}

.search-button-secondary {
  background: #374151;
  color: #e5e7eb;
  border-color: #4b5563;
  box-shadow: none;
}

.search-button-secondary:hover {
  background: #4b5563;
  border-color: #6b7280;
}

.search-panel.mini #advancedFilters {
  display: none;
}


    /* ==========================
       TOGGLE FOND OSM / SAT
    =========================== */
    .leaflet-control-basemap-toggle a {
      width: 34px;
      height: 26px;
      line-height: 26px;
      text-align: center;
      text-decoration: none;
      display: block;
      background: #fff;
      color: #111827;
      font-size: 11px;
      border-bottom: 1px solid #ccc;
    }

    .leaflet-control-basemap-toggle a:last-child {
      border-bottom: none;
    }

    .leaflet-control-basemap-toggle a.active {
      background: #16a34a;
      color: #fff;
      font-weight: 600;
    }

    /* ==========================
       PANNEAU INFOS DROITE
    =========================== */
   .info-sidebar {
  position: absolute;
  top: 20px;
  right: 20px;
  height: calc(100% - 40px);
  width: 360px;
  max-width: 90vw;
  background: #1f2937; /* gris tr√®s fonc√© */
  border-radius: 18px;
  box-shadow: 0 10px 35px rgba(0,0,0,0.45);
  z-index: 9000;
  display: flex;
  flex-direction: column;
  transform: translateX(200%);
  opacity: 0;
  transition: transform 0.25s ease-out, opacity 0.25s ease-out;
  color: #ffffff; /* texte blanc */
  border: 1px solid rgba(255,255,255,0.12);
}

    .info-sidebar.visible {
  transform: translateX(0);
  opacity: 1;
}

    .info-sidebar-header {
  padding: 16px 20px;
  border-bottom: 1px solid rgba(255,255,255,0.15);
  background: #111827; /* plus fonc√© pour la barre du haut */
  border-radius: 18px 18px 0 0;
}

    .info-sidebar-title-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .info-sidebar-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: #16a34a;
      font-weight: 600;
    }

    .info-sidebar-title {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .info-sidebar-close-btn {
      border: none;
      background: #ffffff;
      width: 26px;
      height: 26px;
      padding: 0;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      color: #6b7280;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: background 0.15s, color 0.15s, transform 0.06s;
    }

    .info-sidebar-close-btn:hover {
      background: #f3f4f6;
      color: #111827;
    }

    .info-sidebar-close-btn:active {
      transform: translateY(1px);
    }

 .info-sidebar-content {
  padding: 18px 22px 22px;
  overflow-y: auto;
  font-size: 14px;
  line-height: 1.55;
  color: #e5e7eb; /* gris clair */
}

    .info-section {
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px dashed #e5e7eb;
    }

    .info-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .info-section-title {
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .06em;
  color: #60a5fa; /* bleu clair */
  margin-bottom: 6px;
}

    .info-field {
      margin: 2px 0;
    }

    .info-field-label {
  color: #93c5fd;
  font-weight: 600;
}

.info-field-value {
  color: #ffffff;
}

    .info-pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 11px;
      margin-right: 4px;
      margin-bottom: 2px;
      background: #eef2ff;
      color: #3730a3;
    }

    /* ==========================
   SEARCH UI (GoR√©nove-like)
========================== */
.search-shell{
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  pointer-events: none; /* on rend cliquable seulement la card */
  z-index: 15000;
  padding: 22px;
}

.search-card{
  pointer-events: auto;
  width: min(860px, 92vw);
  background: rgba(255,255,255,0.92);
  border: 1px solid rgba(15,23,42,0.10);
  border-radius: 22px;
  box-shadow: 0 24px 70px rgba(15,23,42,0.18);
  backdrop-filter: blur(10px);
  overflow: hidden;
  color: #0f172a;
}

.search-top{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  padding: 16px 18px;
  border-bottom: 1px solid rgba(15,23,42,0.08);
  background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.88));
}

.search-branding{
  display:flex;
  align-items:center;
  gap: 12px;
  min-width: 0;
}

.brand-logo{
  width: 34px;
  height: 34px;
  border-radius: 10px;
  object-fit: contain;
  background: rgba(22,163,74,0.08);
  border: 1px solid rgba(22,163,74,0.18);
  padding: 6px;
}

.brand-text{ min-width:0; }
.brand-name{
  font-weight: 800;
  letter-spacing: 0.01em;
}
.brand-tagline{
  font-size: 12px;
  color: rgba(15,23,42,0.62);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.search-main{
  padding: 16px 18px 10px;
}

.input-wrap{
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 10px;
  border-radius: 18px;
  border: 1px solid rgba(15,23,42,0.10);
  background: rgba(15,23,42,0.03);
}

.input-ico{ font-size: 14px; opacity: 0.75; }
.input{
  width: 100%;
  border: 1px solid rgba(15,23,42,0.12);
  background: rgba(255,255,255,0.96);
  color: #0f172a;
  border-radius: 14px;
  padding: 12px 12px;
  outline: none;
}
.input:focus{
  border-color: rgba(14,165,233,0.55);
  box-shadow: 0 0 0 4px rgba(14,165,233,0.16);
}

.btn-primary{
  flex: 0 0 auto;
  border: 1px solid rgba(22,163,74,0.35);
  background: linear-gradient(180deg, rgba(34,197,94,0.96), rgba(22,163,74,0.96));
  color: #053a2b;
  border-radius: 999px;
  padding: 12px 14px;
  font-weight: 800;
  cursor: pointer;
  box-shadow: 0 14px 24px rgba(22,163,74,0.18);
}
.btn-primary:hover{ transform: translateY(-1px); }

.filters{
  padding: 6px 18px 16px;
}

.grid{
  display:grid;
  grid-template-columns: 1.2fr 0.8fr;
  gap: 12px;
}
.field{ display:flex; flex-direction: column; gap: 6px; }
.field.span2{ grid-column: 1 / -1; }

.label{
  font-size: 12px;
  font-weight: 700;
  color: rgba(15,23,42,0.65);
}

.row{ display:flex; gap: 10px; }

.actions{
  display:flex;
  flex-wrap: wrap;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 14px;
}

.btn-ghost{
  border: 1px solid rgba(15,23,42,0.12);
  background: rgba(255,255,255,0.92);
  color: #0f172a;
  border-radius: 999px;
  padding: 10px 12px;
  cursor:pointer;
}
.btn-ghost:hover{ background: rgba(15,23,42,0.04); }

.btn-success{
  border: 1px solid rgba(5,150,105,0.28);
  background: linear-gradient(180deg, rgba(34,197,94,0.95), rgba(5,150,105,0.95));
  color: #053a2b;
  border-radius: 999px;
  padding: 10px 12px;
  font-weight: 800;
  cursor:pointer;
}

.status{
  padding: 12px 18px 16px;
  font-size: 12px;
  color: rgba(15,23,42,0.68);
  white-space: pre-line;
}

/* Bouton "Filtres" (utile en mode mini sur la carte) */
.chip-btn{
  display:none; /* visible seulement sur la carte */
  align-items:center;
  gap: 8px;
  border: 1px solid rgba(15,23,42,0.12);
  background: rgba(255,255,255,0.92);
  border-radius: 999px;
  padding: 10px 12px;
  cursor:pointer;
  font-weight: 800;
}
.chev{ opacity: 0.7; }

/* ========== MODE CARTE (mini panneau flottant) ========== */
.search-shell.on-map{
  position: absolute;
  inset: auto;
  top: 16px;
  left: 16px;
  width: auto;
  height: auto;
  display: block;
  padding: 0;
  pointer-events: none;
}
.search-shell.on-map .search-card{
  pointer-events: auto;
  width: 380px;
  border-radius: 18px;
}

/* en mode carte, on affiche le bouton filtres + on r√©duit le contenu */
.search-shell.on-map .chip-btn{ display:inline-flex; }
.search-shell.on-map .grid,
.search-shell.on-map .actions{
  display: none;
}
.search-shell.on-map .filters.collapsed .grid,
.search-shell.on-map .filters.collapsed .actions{
  display: none;
}
.search-shell.on-map .filters.expanded .grid,
.search-shell.on-map .filters.expanded .actions{
  display: grid;
}
.search-shell.on-map .filters.expanded .actions{
  display:flex;
}

/* responsive */
@media (max-width: 620px){
  .grid{ grid-template-columns: 1fr; }
  .field.span2{ grid-column: auto; }
  .search-shell.on-map .search-card{ width: min(92vw, 420px); }
}
/* LOGO FIXE (haut gauche) */
.brand-fixed{
  position: fixed;
  top: 14px;
  left: 14px;
  z-index: 25000;
  background: rgba(255,255,255,0.85);
  border: 1px solid rgba(15,23,42,0.10);
  backdrop-filter: blur(8px);
  border-radius: 14px;
  padding: 10px 12px;
  box-shadow: 0 14px 40px rgba(15,23,42,0.12);
  display: flex;
  align-items: center;
  gap: 10px;
}

.brand-fixed img{
  height: 26px;
  display: block;
}

/* Au d√©but : panneau centr√© */
.search-shell{
  position: fixed;          /* IMPORTANT: fixed plut√¥t que absolute */
  inset: 0;
  display: grid;
  place-items: center;
  pointer-events: none;
  z-index: 20000;
  padding: 22px;
}

/* Quand on passe "sur la carte" -> mini en haut √† gauche */
.search-shell.on-map{
  position: fixed;
  inset: auto;
  top: 62px;                /* laisse la place au logo */
  left: 14px;
  width: auto;
  height: auto;
  display: block;
  padding: 0;
  pointer-events: none;
}
/* ==========================
   LEAFLET LAYERS (dark glass premium)
   (m√™me style que ton panneau de recherche)
========================== */

.leaflet-top.leaflet-right{ margin-top: 14px; margin-right: 14px; }

/* Boite principale */
.leaflet-control-layers{
  border: 1px solid rgba(255,255,255,0.10) !important;
  border-radius: 16px !important;
  overflow: hidden;
  background: rgba(31,41,55,0.92) !important;  /* #1f2937ee */
  backdrop-filter: blur(10px);
  box-shadow: 0 16px 40px rgba(0,0,0,0.45) !important;
  color: #fff;
  font-family: Arial, sans-serif;
}

/* En mode "pas collapsed" */
.leaflet-control-layers-expanded{
  padding: 12px 12px 10px !important;
  min-width: 240px;
  max-width: 300px;
}

/* S√©parateurs */
.leaflet-control-layers-separator{
  border-top: 1px solid rgba(255,255,255,0.14) !important;
  margin: 10px 0 !important;
}

/* Les deux listes (Fond + Overlays) */
.leaflet-control-layers-base,
.leaflet-control-layers-overlays{
  max-height: 260px;
  overflow: auto;
  padding-right: 6px;
}

/* Scrollbar dark (Chrome / Edge) */
.leaflet-control-layers-base::-webkit-scrollbar,
.leaflet-control-layers-overlays::-webkit-scrollbar{
  width: 10px;
}
.leaflet-control-layers-base::-webkit-scrollbar-thumb,
.leaflet-control-layers-overlays::-webkit-scrollbar-thumb{
  background: rgba(255,255,255,0.18);
  border-radius: 999px;
  border: 3px solid rgba(31,41,55,0.92);
}
.leaflet-control-layers-base::-webkit-scrollbar-track,
.leaflet-control-layers-overlays::-webkit-scrollbar-track{
  background: transparent;
}

/* Ligne d‚Äôoption */
.leaflet-control-layers label{
  display: flex !important;
  align-items: center;
  gap: 10px;
  padding: 8px 8px;
  border-radius: 12px;
  cursor: pointer;
  margin: 2px 0;
  user-select: none;
}
.leaflet-control-layers label:hover{
  background: rgba(255,255,255,0.06);
}

/* Texte */
.leaflet-control-layers label span{
  font-size: 13px;
  color: rgba(255,255,255,0.90);
}

/* Style des radios/checkbox (custom) */
.leaflet-control-layers input[type="radio"],
.leaflet-control-layers input[type="checkbox"]{
  appearance: none;
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 6px;
  border: 1.5px solid rgba(255,255,255,0.22);
  background: rgba(55,65,81,1); /* #374151 */
  display: inline-grid;
  place-items: center;
  flex: 0 0 auto;
}

/* Radio rond */
.leaflet-control-layers input[type="radio"]{
  border-radius: 999px;
}

/* Checked = vert premium */
.leaflet-control-layers input[type="checkbox"]:checked{
  border-color: rgba(34,197,94,0.55);
  background: linear-gradient(180deg, rgba(34,197,94,0.98), rgba(5,150,105,0.98));
}
.leaflet-control-layers input[type="radio"]:checked{
  border-color: rgba(34,197,94,0.55);
  background: linear-gradient(180deg, rgba(34,197,94,0.98), rgba(5,150,105,0.98));
}

/* Symbole Ï≤¥ÌÅ¨ */
.leaflet-control-layers input[type="checkbox"]:checked::after{
  content: "‚úì";
  font-size: 12px;
  color: #053a2b;
  font-weight: 900;
  transform: translateY(-0.5px);
}

/* Point radio */
.leaflet-control-layers input[type="radio"]:checked::after{
  content: "";
  width: 8px;
  height: 8px;
  border-radius: 999px;
  background: #053a2b;
}

/* Responsive */
@media (max-width: 620px){
  .leaflet-control-layers-expanded{
    max-width: 82vw;
  }
}

/* ==========================
   SIDEBAR PREMIUM (bulles/modules)
========================== */

.info-sidebar-title{
  color:#fff !important; /* tu avais un noir, sur fond dark c'est illisible */
}

.premium-wrap{
  display:flex;
  flex-direction: column;
  gap: 12px;
}

.premium-card{
  background: rgba(17,24,39,0.72);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 16px;
  padding: 12px 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.28);
}

.premium-card-head{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  margin-bottom: 10px;
}

.premium-card-title{
  display:flex;
  align-items:center;
  gap: 8px;
  font-size: 12px;
  font-weight: 800;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.88);
}

.premium-chip{
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 999px;
  border: 1px solid rgba(34,197,94,0.35);
  background: rgba(34,197,94,0.12);
  color: #a7f3d0;
  white-space: nowrap;
}

.kv-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.kv{
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 14px;
  padding: 10px 10px;
  min-width: 0;
}

.kv.full{ grid-column: 1 / -1; }

.k{
  font-size: 11px;
  color: rgba(147,197,253,0.95);
  font-weight: 700;
  margin-bottom: 4px;
}

.v{
  font-size: 13px;
  color: rgba(255,255,255,0.95);
  line-height: 1.35;
  word-break: break-word;
}

.actions-row{
  display:flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}

.pbtn{
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.92);
  border-radius: 999px;
  padding: 10px 12px;
  font-size: 12px;
  font-weight: 800;
  cursor: pointer;
}
.pbtn:hover{ background: rgba(255,255,255,0.10); }

.pbtn.primary{
  border: 1px solid rgba(34,197,94,0.35);
  background: linear-gradient(180deg, rgba(34,197,94,0.95), rgba(5,150,105,0.95));
  color: #053a2b;
}

.dpe-badge{
  display:inline-flex;
  align-items:center;
  gap: 8px;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid rgba(96,165,250,0.25);
  background: rgba(96,165,250,0.10);
  color: rgba(255,255,255,0.92);
  font-weight: 800;
  font-size: 12px;
  width: fit-content;
}

.dpe-dot{
  width: 10px;
  height: 10px;
  border-radius: 999px;
  background: rgba(255,255,255,0.55);
  border: 1px solid rgba(255,255,255,0.25);
}

@media (max-width: 620px){
  .kv-grid{ grid-template-columns: 1fr; }
}

  </style>

  <!-- Librairies -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Google Maps JS API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB4izaTwbsKKyjVuOJ2Bu0ZHfZRg7mv-ZA&libraries=places"></script>
  <!-- Plugin Leaflet pour utiliser Google comme fond -->
  <script src="https://unpkg.com/leaflet.gridlayer.googlemutant@0.11.2/dist/Leaflet.GoogleMutant.js"></script>
</head>
<body>


<!-- CARTE -->
<div id="map"></div>
<!-- LOGO FIXE (haut gauche) -->
<div class="brand-fixed">
  <img src="assets/LOGO CITEEN_RVB-min.png" alt="Citeen">
</div>

<!-- PANNEAU DE RECHERCHE -->
<!-- PANNEAU DE RECHERCHE (Premium) -->
<div class="search-shell" id="searchShell">
  <div class="search-card" id="searchPanel">

    <!-- Topbar -->
    <div class="search-top">
      <div class="search-branding">
        <img src="assets/LOGO CITEEN_RVB-min.png" alt="Citeen" class="brand-logo" />
        <div class="brand-text">
          <div class="brand-name">Citeen</div>
          <div class="brand-tagline">Recherche d‚Äôimmeubles ¬∑ Registre des copropri√©t√©s</div>
        </div>
      </div>

      <!-- Bouton qui sera visible sur la carte (mode mini) -->
      <button id="toggleFiltersBtn" class="chip-btn" type="button" aria-expanded="true">
        Filtres
        <span class="chev">‚ñæ</span>
      </button>
    </div>

    <!-- Recherche principale (toujours visible) -->
    <div class="search-main">
      <div class="input-wrap">
        <span class="input-ico">üîé</span>
        <input
          type="text"
          id="searchInput"
          class="input"
          placeholder="Nom de copro, adresse, voie, commune‚Ä¶"
        />
        <button id="searchBtn" class="btn-primary" type="button">Rechercher</button>
      </div>
    </div>

    <!-- Filtres avanc√©s (collapsable en mode mini) -->
    <div class="filters" id="advancedFilters">
      <div class="grid">
        <div class="field">
          <label class="label" for="syndicInput">Nom du syndic</label>
          <input type="text" id="syndicInput" class="input" placeholder="Ex : NEXITY, FONCIA‚Ä¶" />
        </div>

        <div class="field">
          <label class="label" for="cpInput">Code postal</label>
          <input type="text" id="cpInput" class="input" placeholder="Ex : 75014" />
        </div>

        <div class="field span2">
          <label class="label">Ann√©e construction (approx.)</label>
          <div class="row">
            <input type="number" id="anneeMinFilter" class="input" placeholder="Min (ex : 1950)" />
            <input type="number" id="anneeMaxFilter" class="input" placeholder="Max (ex : 2000)" />
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="resetBtn" class="btn-ghost" type="button">R√©initialiser</button>
        <button id="exportBtn" class="btn-ghost" type="button">Exporter (CSV)</button>
        <button id="sendToMondayBtn" class="btn-success" type="button">Envoyer vers Monday</button>
      </div>
    </div>

    <!-- Status -->
    <div class="status" id="status">Chargement des CSV‚Ä¶</div>

  </div>
</div>


<!-- PANNEAU INFOS √Ä DROITE -->
<div id="infoSidebar" class="info-sidebar">
  <div class="info-sidebar-header">
    <div class="info-sidebar-title-wrap">
      <div class="info-sidebar-label">Fiche immeuble</div>
      <div id="infoSidebarTitle" class="info-sidebar-title">S√©lection en cours‚Ä¶</div>
    </div>
    <button id="infoSidebarClose" class="info-sidebar-close-btn" title="Fermer">
      ‚úï
    </button>
  </div>
  <div id="infoSidebarContent" class="info-sidebar-content">
    <p style="font-size:13px; color:#6b7280;">
      Cliquez sur un point de la carte pour afficher ici les informations
      issues du registre des copropri√©t√©s (adresse, syndic, lots, p√©riode de construction‚Ä¶).
    </p>
  </div>
</div>

<script>
/* -----------------------------------------------------
   CONFIG ‚Äì FICHIERS COPRO PAR D√âPARTEMENT
------------------------------------------------------ */
const COPRO_FILES = [
  "csvcopro/registredescopro75.csv",
  "csvcopro/registredescopro77.csv",
  "csvcopro/registredescopro78.csv",
  "csvcopro/registredescopro91.csv",
  "csvcopro/registredescopro92.csv",
  "csvcopro/registredescopro93.csv",
  "csvcopro/registredescopro94.csv",
  "csvcopro/registredescopro95.csv"
];

const MAX_POINTS_DISPLAYED = 50000;

/* API DPE ADEME */
const DPE_API_URL = "https://data.ademe.fr/data-fair/api/v1/datasets/dpe03existant/lines";


/* Donn√©es / index */
const pointIndex = new Map(); // cl√© "lat|lon" -> { lat, lon, copro: [rows] }
let allCoproRows = [];
let lastFilteredPoints = [];
let lastFilteredCoproRows = [];
/* Cache DPE pour √©viter les appels multiples */
const dpeCache = new Map(); // key "lat|lon" -> dpe object


/* Carte / couches */
let map;
let baseOSM, googleSat;
let markerLayer;
let btnOSMRef = null;
let btnSatRef = null;
let currentBase = "osm";
let dpeCollectifLayer = L.layerGroup();
let dpeIndividuelLayer = L.layerGroup();
let dpeNoneLayer = L.layerGroup();
// Calques par classe DPE
const dpeClassLayers = {
  "A": L.layerGroup(),
  "B": L.layerGroup(),
  "C": L.layerGroup(),
  "D": L.layerGroup(),
  "E": L.layerGroup(),
  "F": L.layerGroup(),
  "G": L.layerGroup()
};


/* UI */
let hasSearched = false;
let searchPanelMinimized = false;
let infoSidebarEl = null;
let infoSidebarContentEl = null;
let infoSidebarTitleEl = null;

/* -----------------------------------------------------
   UTILITAIRES
------------------------------------------------------ */
function parseNumberFlexible(value) {
  if (value === undefined || value === null || value === "") return NaN;
  const num = parseFloat(String(value).replace(",", "."));
  return isFinite(num) ? num : NaN;
}

/* -----------------------------------------------------
   GEO ‚Äì LAT/LON POUR COPRO
   (Registre : colonnes "long" et "lat")
------------------------------------------------------ */
function getLatLonFromCoproRow(row) {
  if (!row) return null;

  // 1) lecture brute
  let lat = row["lat"] ?? row["Lat"] ?? row["LAT"];
  let lon = row["long"] ?? row["Long"] ?? row["LONG"];

  // 2) S√©curisation : suppression espaces, guillemets, etc.
  if (typeof lat === "string") lat = lat.trim().replace(",", ".");
  if (typeof lon === "string") lon = lon.trim().replace(",", ".");

  // 3) Conversion
  lat = Number(lat);
  lon = Number(lon);

  // 4) Validation : coordonn√©es r√©alistes IDF
  if (!isFinite(lat) || !isFinite(lon)) return null;
  if (lat < 48 || lat > 49.5) return null;
  if (lon < 1 || lon > 3.8) return null;

  return [lat, lon];
}


/* -----------------------------------------------------
   INDEX ‚Äì UN POINT = UNE COPRO (ici)
------------------------------------------------------ */
function addCoproRowToIndex(row) {
  const coords = getLatLonFromCoproRow(row);
  if (!coords) return;
  const [lat, lon] = coords;

  const key = lat.toFixed(5) + "|" + lon.toFixed(5);

  if (!pointIndex.has(key)) {
    pointIndex.set(key, {
      key,
      lat,
      lon,
      copro: []
    });
  }

  const p = pointIndex.get(key);
  p.copro.push(row);
}

/* -----------------------------------------------------
   SIDEBAR ‚Äì OUVRIR / FERMER
------------------------------------------------------ */
function openSidebar(title, htmlContent) {
  if (!infoSidebarEl || !infoSidebarContentEl || !infoSidebarTitleEl) return;
  infoSidebarTitleEl.textContent = title || "Immeuble";
  infoSidebarContentEl.innerHTML = htmlContent;
  infoSidebarEl.classList.add("visible");
}

function closeSidebar() {
  if (!infoSidebarEl) return;
  infoSidebarEl.classList.remove("visible");
}

/* -----------------------------------------------------
   CONTENU DE LA FICHE IMMEUBLE
------------------------------------------------------ */
function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function buildSidebarHtmlForPoint(p) {
  const c = p.copro[0] || {};

  const nomCopro =
    c["nom_d_usage_de_la_copropriete"] ||
    c["nom_d_usage_de_la_copropriete_COPRO"] ||
    c["nom_d_usage_copropriete"] ||
    "Copropri√©t√©";

  const adresse =
    c["adresse_de_reference"] ||
    ((c["numero_et_voie_adresse_de_reference"] || "") + " " +
     (c["adresse_complementaire_1"] || "")).trim();

  const cp =
    c["code_postal_adresse_de_reference"] ||
    c["code_postal"] ||
    "";

  const commune =
    c["commune_adresse_de_reference"] ||
    c["nom_officiel_commune"] ||
    c["commune"] ||
    "";

  const syndic =
    c["raison_sociale_du_representant_legal"] ||
    "Non renseign√©";

  const typeSyndic =
    c["type_de_syndic_benevole_professionnel_non_connu"] ||
    "Non renseign√©";

  const numImmat =
    c["numero_d_immatriculation"] ||
    "Non renseign√©";

  const periodeConstr =
    c["periode_de_construction"] ||
    "Non renseign√©e";

  const nbLotsTotal =
    c["nombre_total_de_lots"] ||
    "Non renseign√©";

  const nbLotsHab =
    c["nombre_total_de_lots_a_usage_d_habitation_de_bureaux_ou_de_comm"] ||
    c["nombre_de_lots_a_usage_d_habitation"] ||
    "";

  const nbLotsStationnement =
    c["nombre_de_lots_de_stationnement"] ||
    "";

  const gmaps = `https://www.google.com/maps?q=${p.lat},${p.lon}`;

  const lotsDetail =
    (nbLotsHab || nbLotsStationnement)
      ? `${nbLotsHab ? esc(nbLotsHab) + " lots hab./bureaux/com." : ""}${(nbLotsHab && nbLotsStationnement) ? " ¬∑ " : ""}${nbLotsStationnement ? esc(nbLotsStationnement) + " stationnement" : ""}`
      : "‚Äî";

  const html = `
    <div class="premium-wrap">

      <!-- LOCALISATION -->
      <div class="premium-card">
        <div class="premium-card-head">
          <div class="premium-card-title">üìç Localisation</div>
          <div class="premium-chip">${esc(cp)} ${esc(commune)}</div>
        </div>

        <div class="kv-grid">
          <div class="kv full">
            <div class="k">Copropri√©t√©</div>
            <div class="v">${esc(nomCopro)}</div>
          </div>

          <div class="kv full">
            <div class="k">Adresse</div>
            <div class="v">${esc(adresse || "Non renseign√©e")}</div>
          </div>

          <div class="kv">
            <div class="k">Latitude</div>
            <div class="v">${Number(p.lat).toFixed(6)}</div>
          </div>

          <div class="kv">
            <div class="k">Longitude</div>
            <div class="v">${Number(p.lon).toFixed(6)}</div>
          </div>

          <div class="kv full">
            <div class="k">Lien</div>
            <div class="v"><a href="${gmaps}" target="_blank" rel="noopener" style="color:#93c5fd; text-decoration:none;">Ouvrir sur Google Maps ‚Üí</a></div>
          </div>
        </div>
      </div>

      <!-- COPROPRI√âT√â -->
      <div class="premium-card">
        <div class="premium-card-head">
          <div class="premium-card-title">üè¢ Copropri√©t√©</div>
          <div class="premium-chip">${esc(nbLotsTotal)} lots</div>
        </div>

        <div class="kv-grid">
          <div class="kv full">
            <div class="k">N¬∞ immatriculation</div>
            <div class="v">${esc(numImmat)}</div>
          </div>

          <div class="kv full">
            <div class="k">Syndic</div>
            <div class="v">${esc(syndic)}</div>
          </div>

          <div class="kv">
            <div class="k">Type</div>
            <div class="v">${esc(typeSyndic)}</div>
          </div>

          <div class="kv">
            <div class="k">P√©riode</div>
            <div class="v">${esc(periodeConstr)}</div>
          </div>

          <div class="kv full">
            <div class="k">D√©tail lots</div>
            <div class="v">${lotsDetail}</div>
          </div>
        </div>

        <div class="actions-row">
          <button class="pbtn primary" id="exportImmeubleBtn" type="button">Exporter cette fiche (CSV)</button>
        </div>
      </div>

      <!-- DPE : bloc placeholder (rempli apr√®s fetch) -->
      <div class="premium-card" id="dpeCard">
        <div class="premium-card-head">
          <div class="premium-card-title">üîã DPE</div>
          <div class="premium-chip">Chargement‚Ä¶</div>
        </div>

        <div class="kv-grid">
          <div class="kv full">
            <div class="k">Statut</div>
            <div class="v">R√©cup√©ration des diagnostics ADEME‚Ä¶</div>
          </div>
        </div>
      </div>

    </div>
  `;

  return { title: nomCopro, html };
}


/* -----------------------------------------------------
   CARTE LEAFLET + FONDS
------------------------------------------------------ */

async function fetchDPEForCoordinates(lat, lon) {
  const key = lat.toFixed(6) + "|" + lon.toFixed(6);

  // Cache
  if (dpeCache.has(key)) return dpeCache.get(key);

  // Nouvelle API ADEME : r√©cup√©rer TOUS les DPE autour du point
  const url = `${DPE_API_URL}?size=2000&geo_distance=${lon},${lat},50`;

  try {
    const res = await fetch(url);

    if (!res.ok) {
      console.warn("Erreur API ADEME", res.status);
      dpeCache.set(key, []);
      return [];
    }

    const data = await res.json();
    const dpeList = data?.results || [];

    dpeCache.set(key, dpeList);
    return dpeList;

  } catch (e) {
    console.error("Erreur API ADEME", e);
    dpeCache.set(key, []);
    return [];
  }
}


function appendDPEToSidebar(dpeList) {
  if (!infoSidebarContentEl) return;

  const has = Array.isArray(dpeList) && dpeList.length > 0;

  // petit helper anti XSS basique
  const esc = (v) => String(v ?? "").replace(/[&<>"']/g, (m) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));

  // KPI helpers
  const pick = (obj, keys, fallback="Non renseign√©") => {
    for (const k of keys) {
      const val = obj?.[k];
      if (val !== undefined && val !== null && String(val).trim() !== "") return val;
    }
    return fallback;
  };

  // On prend le "meilleur r√©sum√©" : si plusieurs DPE, on affiche un mini r√©sum√© + d√©tails
  let badgeClass = "none";
  let badgeText = "Aucun DPE";
  let headlineClasse = "NR";
  let headlineGes = "NR";
  let headlineType = "‚Äî";
  let headlineDate = "‚Äî";
  let headlineChauffage = "‚Äî";

  if (has) {
    badgeClass = "ok";
    badgeText = `${dpeList.length} DPE trouv√©${dpeList.length > 1 ? "s" : ""}`;

    // on prend le premier pour le "headline" (tu peux changer la logique plus tard)
    const d0 = dpeList[0] || {};
    headlineClasse = pick(d0, ["etiquette_dpe"], "NR");
    headlineGes = pick(d0, ["etiquette_ges"], "NR");
    headlineType = d0.numero_dpe_immeuble_associe ? "Collectif" : "Individuel";
    headlineDate = pick(d0, ["date_etablissement_dpe"], "Non renseign√©e");
    headlineChauffage = pick(d0, ["type_installation_chauffage"], "Non renseign√©");

    // Si la classe est NR mais on a bien des DPE, on √©vite le "ok" trop fort
    if (String(headlineClasse).toUpperCase() === "NR") badgeClass = "warn";
  }

  let html = `
    <div class="premium-wrap">

      <div class="premium-card">
        <div class="premium-head">
          <div>
            <div class="premium-title">üîã Diagnostic √©nerg√©tique</div>
            <div class="premium-sub">Synth√®se DPE (autour du point)</div>
          </div>
          <span class="badge ${badgeClass}">${esc(badgeText)}</span>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="k">Type</div>
            <div class="v">${esc(headlineType)}</div>
          </div>

          <div class="kpi">
            <div class="k">Date</div>
            <div class="v">${esc(headlineDate)}</div>
          </div>

          <div class="kpi">
            <div class="k">Classe √©nergie</div>
            <div class="v">${esc(headlineClasse)}</div>
          </div>

          <div class="kpi">
            <div class="k">Classe GES</div>
            <div class="v">${esc(headlineGes)}</div>
          </div>

          <div class="kpi" style="grid-column:1/-1;">
            <div class="k">Chauffage</div>
            <div class="v small">${esc(headlineChauffage)}</div>
          </div>
        </div>

        
  `;

  // D√©tails si plusieurs DPE
  if (has && dpeList.length > 1) {
    html += `
      <div class="premium-card">
        <div class="premium-head">
          <div>
            <div class="premium-title">üìÑ D√©tails</div>
            <div class="premium-sub">Liste des DPE d√©tect√©s</div>
          </div>
          <span class="badge">${esc(dpeList.length)} √©l√©ments</span>
        </div>

        <div class="kpis">
    `;

    dpeList.slice(0, 12).forEach((dpe, idx) => {
      const typeDPE = dpe.numero_dpe_immeuble_associe ? "Collectif" : "Individuel";
      const numeroDpe = pick(dpe, ["numero_dpe"], "Non renseign√©");
      const dateDpe = pick(dpe, ["date_etablissement_dpe"], "Non renseign√©e");
      const classeE = pick(dpe, ["etiquette_dpe"], "NR");
      const classeG = pick(dpe, ["etiquette_ges"], "NR");

      html += `
        <div class="kpi" style="grid-column:1/-1;">
          <div class="k">DPE #${idx + 1} ‚Ä¢ ${esc(typeDPE)}</div>
          <div class="v small">${esc(numeroDpe)}</div>
          <div class="k" style="margin-top:6px;">Date ‚Ä¢ Classe √©nergie ‚Ä¢ GES</div>
          <div class="v small">${esc(dateDpe)} ‚Ä¢ ${esc(classeE)} ‚Ä¢ ${esc(classeG)}</div>
        </div>
      `;
    });

    if (dpeList.length > 12) {
      html += `
        <div class="kpi" style="grid-column:1/-1;">
          <div class="k">‚Ä¶</div>
          <div class="v small">+${esc(dpeList.length - 12)} DPE suppl√©mentaires (non affich√©s)</div>
        </div>
      `;
    }

    html += `
        </div>
      </div>
    `;
  }

  html += `</div>`; // end premium-wrap

  infoSidebarContentEl.innerHTML += html;

  // Activation du bouton export
  const btn = document.getElementById("exportImmeubleBtn");
  if (btn) {
    btn.addEventListener("click", () => {
      exportSingleImmeubleToCSV(window.selectedCoproForMonday);
    });
  }
}


function initMap() {
  // 1) Fonds
  baseOSM = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  });

  googleSat = L.gridLayer.googleMutant({
    type: "satellite",
    maxZoom: 21
  });

  // 2) Carte
  const boundsIDF = [
    [48.0, 1.4],
    [49.2, 3.6]
  ];

  map = L.map("map", {
    center: [48.8566, 2.3522],
    zoom: 11,
    layers: [baseOSM]
  });

  map.setMaxBounds(boundsIDF);
  map.setMinZoom(9);
  map.options.maxBoundsViscosity = 1.0;
  map.fitBounds(boundsIDF);

  // 3) Layer group principal (IMPORTANT)
  markerLayer = L.layerGroup().addTo(map);

  // 4) Control layers (Fond + DPE)
  const baseLayers = {
    "Fond OSM": baseOSM,
    "Satellite Google": googleSat
  };

  const dpeOverlays = {
    "DPE collectif": dpeCollectifLayer,
    "DPE individuel": dpeIndividuelLayer,
    "Sans donn√©es DPE": dpeNoneLayer,
    "Classe A": dpeClassLayers["A"],
    "Classe B": dpeClassLayers["B"],
    "Classe C": dpeClassLayers["C"],
    "Classe D": dpeClassLayers["D"],
    "Classe E": dpeClassLayers["E"],
    "Classe F": dpeClassLayers["F"],
    "Classe G": dpeClassLayers["G"]
  };

  L.control.layers(baseLayers, dpeOverlays, {
    position: "topright",
    collapsed: false
  }).addTo(map);

  // 5) Ajoute les calques DPE sur la carte (sinon ils restent vides/inactifs)
  dpeCollectifLayer.addTo(map);
  dpeIndividuelLayer.addTo(map);
  dpeNoneLayer.addTo(map);
  Object.values(dpeClassLayers).forEach(layer => layer.addTo(map));

  // 6) Toggle OSM/Sat custom (boutons OSM / Sat)
  const BaseMapToggle = L.Control.extend({
    options: { position: "topleft" },
    onAdd: function(_map) {
      const container = L.DomUtil.create(
        "div",
        "leaflet-control leaflet-bar leaflet-control-basemap-toggle"
      );

      btnOSMRef = L.DomUtil.create("a", "", container);
      btnOSMRef.href = "#";
      btnOSMRef.innerHTML = "OSM";
      btnOSMRef.classList.add("active");

      btnSatRef = L.DomUtil.create("a", "", container);
      btnSatRef.href = "#";
      btnSatRef.innerHTML = "Sat";

      L.DomEvent.disableClickPropagation(container);

      L.DomEvent.on(btnOSMRef, "click", (e) => {
        L.DomEvent.preventDefault(e);
        setBaseLayer("osm");
      });

      L.DomEvent.on(btnSatRef, "click", (e) => {
        L.DomEvent.preventDefault(e);
        setBaseLayer("sat");
      });

      return container;
    }
  });

  map.addControl(new BaseMapToggle());

  // 7) Clic sur la carte = fermer sidebar
  map.on("click", () => closeSidebar());
}


function setBaseLayer(mode) {
  currentBase = mode;

  if (mode === "osm") {
    if (map.hasLayer(googleSat)) map.removeLayer(googleSat);
    if (!map.hasLayer(baseOSM)) map.addLayer(baseOSM);
    if (btnOSMRef && btnSatRef) {
      btnOSMRef.classList.add("active");
      btnSatRef.classList.remove("active");
    }
  } else if (mode === "sat") {
    if (map.hasLayer(baseOSM)) map.removeLayer(baseOSM);
    if (!map.hasLayer(googleSat)) map.addLayer(googleSat);
    if (btnOSMRef && btnSatRef) {
      btnOSMRef.classList.remove("active");
      btnSatRef.classList.add("active");
    }
  }
}

/* -----------------------------------------------------
   CHARGEMENT CSV ‚Äì MULTI FICHIERS
------------------------------------------------------ */
function loadCsv(fileName) {
  return new Promise((resolve, reject) => {
    Papa.parse(fileName, {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      delimiter: ";",
      complete: (result) => {
        resolve(result.data || []);
      },
      error: (err) => {
        reject(err);
      }
    });
  });
}

async function loadAllCoproData() {
  const statusEl = document.getElementById("status");
  statusEl.innerText = "Chargement des registres de copropri√©t√©s‚Ä¶";

  let totalRows = 0;
  let totalWithCoords = 0;

  for (const file of COPRO_FILES) {
    try {
      statusEl.innerText += `\n‚Üí ${file}‚Ä¶`;
      const rows = await loadCsv(file);
      allCoproRows.push(...rows);
      totalRows += rows.length;

      rows.forEach(r => {
        const coords = getLatLonFromCoproRow(r);
        if (coords) {
          totalWithCoords++;
          addCoproRowToIndex(r);
        }
      });

      console.log("Charg√© :", file, "lignes :", rows.length);
    } catch (e) {
      console.error("Erreur CSV COPRO sur", file, e);
      statusEl.innerText += `\n‚ö†Ô∏è Erreur sur ${file} (voir console).`;
    }
  }

  statusEl.innerText +=
    `\n\nTotal lignes COPRO : ${totalRows}` +
    `\nImmeubles g√©olocalis√©s (points) : ${pointIndex.size}` +
    `\nLancez une recherche pour afficher les points.`;

  console.log("PointIndex size :", pointIndex.size);
}

/* -----------------------------------------------------
   RENDU DES POINTS
------------------------------------------------------ */
function renderPoints(points) {
  // On vide tous les calques
  markerLayer.clearLayers();
  dpeCollectifLayer.clearLayers();
  dpeIndividuelLayer.clearLayers();
  dpeNoneLayer.clearLayers();
  Object.values(dpeClassLayers).forEach(layer => layer.clearLayers());

  const bounds = [];
  let displayed = 0;

  for (const p of points) {
    if (displayed >= MAX_POINTS_DISPLAYED) break;

    const lat = p.lat;
    const lon = p.lon;
    if (!isFinite(lat) || !isFinite(lon)) continue;

    /* --------------------------------------------------
       1) D√©terminer la couleur AVANT cr√©ation du marker
    -------------------------------------------------- */
    let markerColor = "#000000"; // Noir = pas de DPE par d√©faut

    const cacheKey = lat.toFixed(6) + "|" + lon.toFixed(6);
    const cachedDPE = dpeCache.get(cacheKey);

if (cachedDPE && cachedDPE.length > 0) {
  const hasCollectif = cachedDPE.some(d => d.numero_dpe_immeuble_associe);
  const hasIndividuel = cachedDPE.some(d => !d.numero_dpe_immeuble_associe);

  if (hasCollectif) markerColor = "#3388ff"; // bleu
  else if (hasIndividuel) markerColor = "#ff0000"; // rouge
  else markerColor = "#000000"; // noir
}


    /* --------------------------------------------------
       2) Cr√©ation du marker
    -------------------------------------------------- */
    const marker = L.circleMarker([lat, lon], {
      radius: 5,
      color: markerColor,
      fillColor: markerColor,
      fillOpacity: 0.85,
      weight: 1
    }).on("click", async (e) => {
      L.DomEvent.stopPropagation(e);
      const { title, html } = buildSidebarHtmlForPoint(p);
      openSidebar(title, html);
      window.selectedCoproForMonday = p;

      infoSidebarContentEl.innerHTML += `
        <div id="dpe-loading" class="info-section">
          <div class="info-section-title">DPE</div>
          <div class="info-field">Chargement‚Ä¶</div>
        </div>`;

      const dpeFull = await fetchDPEForCoordinates(p.lat, p.lon);
      const ld = document.getElementById("dpe-loading");
      if (ld) ld.remove();
      appendDPEToSidebar(dpeFull);
    });

    // Ajout aux calques par d√©faut
    markerLayer.addLayer(marker);
    dpeNoneLayer.addLayer(marker); // si pas de DPE ‚Üí noir

    /* --------------------------------------------------
       3) Mise √† jour couleur apr√®s r√©cup√©ration du DPE
    -------------------------------------------------- */
    fetchDPEForCoordinates(lat, lon)
  .then((dpeList) => {
    if (!dpeList || dpeList.length === 0) {
      marker.setStyle({ color: "#000000", fillColor: "#000000" });
      return;
    }

    // y a-t-il un DPE collectif ?
   const hasCollectif = dpeList.some(d => d.numero_dpe_immeuble_associe);
const hasIndividuel = dpeList.some(d => !d.numero_dpe_immeuble_associe);


    dpeNoneLayer.removeLayer(marker);

    if (hasCollectif) {
      marker.setStyle({ color: "#3388ff", fillColor: "#3388ff" });
      dpeCollectifLayer.addLayer(marker);

    } else if (hasIndividuel) {
      marker.setStyle({ color: "#ff0000", fillColor: "#ff0000" });
      dpeIndividuelLayer.addLayer(marker);

    } else {
      marker.setStyle({ color: "#000000", fillColor: "#000000" });
      dpeNoneLayer.addLayer(marker);
    }

    // Ajout classes √©nerg√©tiques (toutes)
    dpeList.forEach(d => {
      const classe = (d.etiquette_dpe || "").toUpperCase();
      if (["A","B","C","D","E","F","G"].includes(classe)) {
        dpeClassLayers[classe].addLayer(marker);
      }
    });
  })
  .catch((err) => {
    console.error("Erreur DPE pour calques :", err);
  });

    bounds.push([lat, lon]);
    displayed++;
  }

  if (bounds.length > 0) {
    map.fitBounds(bounds, { padding: [20, 20] });
  }
}

/* -----------------------------------------------------
   FILTRES
------------------------------------------------------ */
function extractYearRangeFromPeriode(periodeStr) {
  if (!periodeStr) return null;
  const matches = String(periodeStr).match(/(19|20)\d{2}/g);
  if (!matches || matches.length === 0) return null;

  const years = matches.map(y => parseInt(y, 10)).filter(y => !isNaN(y));
  if (years.length === 0) return null;

  const minY = Math.min(...years);
  const maxY = Math.max(...years);
  return { min: minY, max: maxY };
}

function applyFilters() {
  const adresse      = document.getElementById("searchInput").value.toLowerCase().trim();
  const syndicFilter = document.getElementById("syndicInput").value.toLowerCase().trim();
  const cpFilter     = document.getElementById("cpInput").value.trim();
  const anneeMin     = parseInt(document.getElementById("anneeMinFilter").value, 10);
  const anneeMax     = parseInt(document.getElementById("anneeMaxFilter").value, 10);

  const filteredPoints = [];
  lastFilteredCoproRows = [];

  pointIndex.forEach(p => {
    let match = true;

    const c = p.copro[0] || {};

    // Adresse
    if (adresse) {
      const addrConcat =
        (c["nom_d_usage_de_la_copropriete"] || "") + " " +
        (c["adresse_de_reference"] || "") + " " +
        (c["numero_et_voie_adresse_de_reference"] || "") + " " +
        (c["commune_adresse_de_reference"] || "") + " " +
        (c["commune"] || "");
      if (!addrConcat.toLowerCase().includes(adresse)) {
        match = false;
      }
    }

    // Syndic
    if (match && syndicFilter) {
      const syndic =
        (c["raison_sociale_du_representant_legal"] || "").toLowerCase();
      if (!syndic.includes(syndicFilter)) {
        match = false;
      }
    }

    // Code postal
    if (match && cpFilter) {
      const cp =
        c["code_postal_adresse_de_reference"] ||
        c["code_postal"] ||
        "";
      if (!String(cp).startsWith(cpFilter)) {
        match = false;
      }
    }

    // P√©riode de construction approximative
    if (match && (!isNaN(anneeMin) || !isNaN(anneeMax))) {
      const periode =
        c["periode_de_construction"] ||
        "";
      const yr = extractYearRangeFromPeriode(periode);
      if (yr) {
        if (!isNaN(anneeMin) && yr.max < anneeMin) match = false;
        if (!isNaN(anneeMax) && yr.min > anneeMax) match = false;
      }
      // si pas d'info, on ne filtre pas plus (on laisse passer)
    }

    if (match) {
      filteredPoints.push(p);
      lastFilteredCoproRows.push(...p.copro);
    }
  });

  lastFilteredPoints = filteredPoints;
  renderPoints(filteredPoints);

  const statusEl = document.getElementById("status");
  statusEl.innerText =
    `Immeubles g√©olocalis√©s dans l'index : ${pointIndex.size}\n` +
    `Immeubles correspondant aux filtres : ${filteredPoints.length}\n` +
    `Lignes registre correspondantes : ${lastFilteredCoproRows.length}`;
}

/* -----------------------------------------------------
   EXPORT CSV
------------------------------------------------------ */
async function exportFilteredToCSV() {
  if (!lastFilteredCoproRows || lastFilteredCoproRows.length === 0) {
    alert("Aucune copropri√©t√© filtr√©e √† exporter. Lancez une recherche.");
    return;
  }

  // 1. Charger tous les DPE pour les points filtr√©s
  for (const p of lastFilteredPoints) {
    await fetchDPEForCoordinates(p.lat, p.lon);
  }

  // 2. Enrichir les lignes des registres avec les champs DPE
const enrichedRows = [];

lastFilteredCoproRows.forEach(row => {
  const coords = getLatLonFromCoproRow(row);
  if (!coords) {
    enrichedRows.push({ ...row });
    return;
  }

  const [lat, lon] = coords;
  const key = lat.toFixed(6) + "|" + lon.toFixed(6);
  const dpeList = dpeCache.get(key) || [];

  if (dpeList.length === 0) {
    // Pas de DPE ‚Üí ligne simple
    enrichedRows.push({
      ...row,
      dpe_type: "",
      dpe_numero: "",
      dpe_date: "",
      dpe_classe_energie: "",
      dpe_classe_ges: "",
      dpe_energie_chauffage: ""
    });
  } else {
    // 1 ligne PAR DPE
    dpeList.forEach(dpe => {
      enrichedRows.push({
        ...row,
        dpe_type: dpe.numero_dpe_immeuble_associe ? "Collectif" : "Individuel",
        dpe_numero: dpe.numero_dpe || "",
        dpe_date: dpe.date_etablissement_dpe || "",
        dpe_classe_energie: dpe.etiquette_dpe || "",
        dpe_classe_ges: dpe.etiquette_ges || "",
        dpe_energie_chauffage: dpe.type_installation_chauffage || ""
      });
    });
  }
});

  // 3. Conversion CSV
  const csv = Papa.unparse(enrichedRows, { delimiter: ";" });

  // 4. Download
  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.href = url;
  link.download = "export_citeen_copro_filtre_dpe.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}
/* -----------------------------------------------------
   EXPORT CSV ‚Äì UNE SEULE FICHE IMMEUBLE
------------------------------------------------------ */
function exportSingleImmeubleToCSV(p) {
  if (!p) {
    alert("Aucune fiche immeuble s√©lectionn√©e.");
    return;
  }

  const c = p.copro[0] || {};

  // Donn√©es immeuble
  const immeubleInfo = {
    nom: c["nom_d_usage_de_la_copropriete"] || "",
    adresse:
      ((c["numero_et_voie_adresse_de_reference"] || "") + " " +
      (c["adresse_complementaire_1"] || "") + " " +
      (c["adresse_de_reference"] || "")).replace(/\s\s+/g, " ").trim(),
    cp: c["code_postal_adresse_de_reference"] || "",
    ville: c["commune_adresse_de_reference"] || "",
    syndic: c["raison_sociale_du_representant_legal"] || "",
    lots_total: c["nombre_total_de_lots"] || "",
    periode: c["periode_de_construction"] || "",
    latitude: p.lat,
    longitude: p.lon
  };

  // üî• R√©cup√©rer les DPE du cache
  const key = `${p.lat.toFixed(6)}|${p.lon.toFixed(6)}`;
  const dpeList = dpeCache.get(key) || [];

  let rows = [];

  // üî• S'il y a des DPE ‚Üí 1 ligne par DPE
  if (dpeList.length > 0) {
    rows = dpeList.map(d => ({
      ...immeubleInfo,
      dpe_numero: d.numero_dpe || "",
      dpe_date: d.date_etablissement_dpe || "",
      dpe_type: d.numero_dpe_immeuble_associe ? "Collectif" : "Individuel",
      dpe_classe_energie: d.etiquette_dpe || "",
      dpe_conso:
        d.consommation_energie ||
        d.consommation_energie_5_usages || "",
      dpe_ges: d.etiquette_ges || "",
      dpe_energie_chauffage:
        d.type_installation_chauffage ||
        d.type_energie_chauffage ||
        d.energie_chauffage ||
        ""
    }));
  }

  // ‚ùóÔ∏èS'il n'y a AUCUN DPE ‚Üí une seule ligne immeuble
  else {
    rows.push({
      ...immeubleInfo,
      dpe_numero: "",
      dpe_date: "",
      dpe_type: "",
      dpe_classe_energie: "",
      dpe_conso: "",
      dpe_ges: "",
      dpe_energie_chauffage: ""
    });
  }

  // Convertir en CSV
  const csv = Papa.unparse(rows, { delimiter: ";" });

  // T√©l√©charger
  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `fiche_immeuble_${immeubleInfo.nom.replace(/\s+/g, "_")}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  URL.revokeObjectURL(url);
}


/* -----------------------------------------------------
   R√âINITIALISATION
------------------------------------------------------ */
function resetFilters() {
  document.getElementById("searchInput").value = "";
  document.getElementById("syndicInput").value = "";
  document.getElementById("cpInput").value = "";
  document.getElementById("anneeMinFilter").value = "";
  document.getElementById("anneeMaxFilter").value = "";

  markerLayer.clearLayers();
  lastFilteredCoproRows = [];
  lastFilteredPoints = [];

  hasSearched = false;
  searchPanelMinimized = false;

    const searchShell = document.getElementById("searchShell");
  if (searchShell) searchShell.classList.remove("on-map");

  const advancedFilters = document.getElementById("advancedFilters");
  if (advancedFilters) {
    advancedFilters.classList.add("expanded");
    advancedFilters.classList.remove("collapsed");
  }

  const toggleFiltersBtn = document.getElementById("toggleFiltersBtn");
  if (toggleFiltersBtn) {
    toggleFiltersBtn.setAttribute("aria-expanded", "true");
    const chev = toggleFiltersBtn.querySelector(".chev");
    if (chev) chev.textContent = "‚ñæ";
  }


  const statusEl = document.getElementById("status");
  statusEl.innerText =
    "Recherche r√©initialis√©e.\nAucun point affich√©. Lancez une recherche.";

  closeSidebar();
}

/* -----------------------------------------------------
   MINIMISATION PANEL
------------------------------------------------------ */
function minimizeSearchPanel() {
  if (searchPanelMinimized) return;

  const searchShell = document.getElementById("searchShell");
  if (searchShell) searchShell.classList.add("on-map");

  // en mode mini on ferme les filtres par d√©faut
  const advancedFilters = document.getElementById("advancedFilters");
  if (advancedFilters) {
    advancedFilters.classList.remove("expanded");
    advancedFilters.classList.add("collapsed");
  }

  const toggleFiltersBtn = document.getElementById("toggleFiltersBtn");
  if (toggleFiltersBtn) {
    toggleFiltersBtn.setAttribute("aria-expanded", "false");
    const chev = toggleFiltersBtn.querySelector(".chev");
    if (chev) chev.textContent = "‚ñæ";
  }

  searchPanelMinimized = true;
}

/* -----------------------------------------------------
   DOM READY
------------------------------------------------------ */
document.addEventListener("DOMContentLoaded", () => {
  initMap();

  infoSidebarEl = document.getElementById("infoSidebar");
  infoSidebarContentEl = document.getElementById("infoSidebarContent");
  infoSidebarTitleEl = document.getElementById("infoSidebarTitle");
  const infoSidebarClose = document.getElementById("infoSidebarClose");
  if (infoSidebarClose) {
    infoSidebarClose.addEventListener("click", closeSidebar);
  }

  // S'assurer que le bandeau est bien cach√© au d√©part
  closeSidebar();

  const openingScreen = document.getElementById("openingScreen");
  const enterAppBtn   = document.getElementById("enterAppBtn");

  if (enterAppBtn && openingScreen) {
    enterAppBtn.addEventListener("click", () => {
      openingScreen.classList.add("hidden");
    });
  }

  const searchBtn   = document.getElementById("searchBtn");
  const resetBtn    = document.getElementById("resetBtn");
  const exportBtn   = document.getElementById("exportBtn");
  const searchInput = document.getElementById("searchInput");
    // --- Mode "carte" (mini panneau) + bouton Filtres ---
  const searchShell = document.getElementById("searchShell");
  const toggleFiltersBtn = document.getElementById("toggleFiltersBtn");
  const advancedFilters = document.getElementById("advancedFilters");

  // √©tat filtres en mode mini
  let filtersOpen = false;

  function setOnMapMode(onMap) {
    if (!searchShell) return;
    if (onMap) searchShell.classList.add("on-map");
    else searchShell.classList.remove("on-map");
  }

  function setFilters(open) {
    if (!advancedFilters) return;
    filtersOpen = open;

    // on utilise les classes collapsed/expanded pr√©vues dans ton CSS
    advancedFilters.classList.toggle("expanded", open);
    advancedFilters.classList.toggle("collapsed", !open);

    if (toggleFiltersBtn) {
      toggleFiltersBtn.setAttribute("aria-expanded", String(open));
      toggleFiltersBtn.querySelector(".chev").textContent = open ? "‚ñ¥" : "‚ñæ";
    }
  }

  // au d√©part: centr√©, filtres visibles (par d√©faut)
  setOnMapMode(false);
  setFilters(true);

  if (toggleFiltersBtn) {
    toggleFiltersBtn.addEventListener("click", () => {
      setFilters(!filtersOpen);
    });
  }

  if (searchBtn) {
    searchBtn.addEventListener("click", () => {
      hasSearched = true;
      applyFilters();
      minimizeSearchPanel();
    });
  }

  if (resetBtn) {
    resetBtn.addEventListener("click", resetFilters);
  }

  if (exportBtn) {
    exportBtn.addEventListener("click", exportFilteredToCSV);
  }

  if (searchInput) {
    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        hasSearched = true;
        applyFilters();
        minimizeSearchPanel();
      }
    });
    searchInput.addEventListener("input", () => {
      if (hasSearched) applyFilters();
    });
  }

  const syndicInput   = document.getElementById("syndicInput");
  const cpInput       = document.getElementById("cpInput");
  const anneeMinInput = document.getElementById("anneeMinFilter");
  const anneeMaxInput = document.getElementById("anneeMaxFilter");

  const liveApply = () => { if (hasSearched) applyFilters(); };

  if (syndicInput)   syndicInput.addEventListener("input", liveApply);
  if (cpInput)       cpInput.addEventListener("input", liveApply);
  if (anneeMinInput) anneeMinInput.addEventListener("input", liveApply);
  if (anneeMaxInput) anneeMaxInput.addEventListener("input", liveApply);

  // Chargement de tous les CSV COPRO
  loadAllCoproData();
});

// ===========================================
// ENVOI D'UNE COPRO S√âLECTIONN√âE VERS MAKE/MONDAY
// ===========================================

const MAKE_WEBHOOK_URL = "https://hook.eu1.make.com/48g98us3j9xvrk6b6xetlocysjoa558y";

document.getElementById("sendToMondayBtn").addEventListener("click", async () => {

    const p = window.selectedCoproForMonday;

    if (!p) {
        alert("Veuillez d'abord cliquer sur un immeuble pour l'envoyer vers Monday.");
        return;
    }

    const c = p.copro[0] || {};

    console.log("Copro RAW:", c);

    const nom = c["nom_d_usage_de_la_copropriete"] || "Non renseign√©";

    const adresse = [
        c["numero_et_voie_adresse_de_reference"] || "",
        c["adresse_complementaire_1"] || "",
        c["adresse_de_reference"] || ""
    ].join(" ").replace(/\s\s+/g, " ").trim();

    const cp = c["code_postal_adresse_de_reference"] || "";
    const ville = c["commune_adresse_de_reference"] || "";
    const syndic = c["raison_sociale_du_representant_legal"] || "";
    const lots = c["nombre_total_de_lots"] || "";
    const periode = c["periode_de_construction"] || "";

    // DPE r√©cup√©r√© en cache
    const dpeKey = `${p.lat.toFixed(6)}|${p.lon.toFixed(6)}`;
    const dpe = dpeCache.get(dpeKey);
    const classeDPE = dpe?.classe_consommation_energie || "NR";

    const lienGoogleMaps = `https://www.google.com/maps?q=${p.lat},${p.lon}`;

    const payload = {
        nom_immeuble: nom,
        adresse: adresse,
        cp: cp,
        ville: ville,
        syndic: syndic,
        lots_total: lots,
        periode_construction: periode,
        classe_dpe: classeDPE,
        lien_google_maps: lienGoogleMaps,
        statut: "√Ä contacter",
        date_import: new Date().toISOString().split("T")[0]
    };

    console.log("üì§ ENVOI VERS MAKE :", payload);

    try {
        const res = await fetch(MAKE_WEBHOOK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            alert("Immeuble envoy√© vers Monday ‚úîÔ∏è");
        } else {
            alert("Erreur lors de l‚Äôenvoi ‚ùå");
        }

    } catch (e) {
        console.error("SEND ERROR", e);
        alert("Erreur r√©seau.");
    }
});

</script>

</body>
</html>